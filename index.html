<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K√©o Co Ki·∫øn Th·ª©c ‚Äì AI Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800;900&family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* =====================================================
   ROOT & RESET
   ===================================================== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --g6: #ff6b35; --g6b: #ff9a5c;
  --g7: #10b981; --g7b: #34d399;
  --g8: #3b82f6; --g8b: #60a5fa;
  --g9: #a855f7; --g9b: #c084fc;

  --red: #ef4444; --red2: #fca5a5; --red3: #1f0a0a;
  --blue: #3b82f6; --blue2: #93c5fd; --blue3: #0a1020;

  --bg: #0d0f1a;
  --bg2: #131629;
  --bg3: #1a1d35;
  --card: #1e2240;
  --card2: #252850;
  --border: rgba(255,255,255,.08);
  --border2: rgba(255,255,255,.14);

  --text: #e8eaf6;
  --text2: #9ba3c9;
  --text3: #5a6190;

  --gold: #fbbf24; --gold2: #fde68a;
  --green: #10b981; --green2: #34d399;

  --ga: var(--g6); --gb: var(--g6b);

  --r: 16px; --rs: 10px; --rm: 20px;
  --sh: 0 8px 32px rgba(0,0,0,.5);
  --sh2: 0 2px 12px rgba(0,0,0,.3);
}

body {
  font-family: 'Be Vietnam Pro', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* =====================================================
   SCREEN SYSTEM
   ===================================================== */
.screen { display: none; min-height: 100vh; flex-direction: column; }
.screen.active { display: flex; }

/* =====================================================
   GLOBAL COMPONENTS
   ===================================================== */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  padding: 11px 22px; border-radius: 50px; border: none; cursor: pointer;
  font-family: 'Be Vietnam Pro', sans-serif; font-weight: 700;
  font-size: .92rem; transition: all .2s; outline: none; white-space: nowrap;
}
.btn-ai {
  background: linear-gradient(135deg, #7c3aed, #4f46e5, #0ea5e9);
  background-size: 200% 200%; color: white;
  box-shadow: 0 4px 20px rgba(124,58,237,.45);
  animation: gradShift 3s ease infinite;
}
.btn-ai:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(124,58,237,.65); }
@keyframes gradShift {
  0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}
}
.btn-primary {
  background: linear-gradient(135deg, var(--ga), var(--gb));
  color: white; box-shadow: 0 4px 18px rgba(0,0,0,.4);
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 26px rgba(0,0,0,.5); }
.btn-ghost {
  background: rgba(255,255,255,.06); color: var(--text2);
  border: 1px solid var(--border2);
}
.btn-ghost:hover { background: rgba(255,255,255,.12); color: var(--text); }
.btn-gold {
  background: linear-gradient(135deg, var(--gold), #d97706);
  color: #1a0a00; box-shadow: 0 4px 18px rgba(251,191,36,.35);
}
.btn-gold:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(251,191,36,.55); }
.btn-sm { padding: 8px 16px; font-size: .8rem; }
.btn-lg { padding: 15px 32px; font-size: 1.05rem; }
.btn-xl { padding: 18px 40px; font-size: 1.15rem; }
.btn:disabled { opacity: .5; cursor: not-allowed; transform: none !important; }

.card {
  background: var(--card); border-radius: var(--r);
  border: 1px solid var(--border); box-shadow: var(--sh2);
}

.badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 12px; border-radius: 20px; font-size: .75rem;
  font-weight: 700; letter-spacing: .4px;
}
.badge-ai { background: rgba(124,58,237,.25); color: #a78bfa; border: 1px solid rgba(124,58,237,.4); }
.badge-grade { background: rgba(255,255,255,.08); color: var(--text2); border: 1px solid var(--border); }
.badge-new { background: rgba(16,185,129,.2); color: var(--green2); border: 1px solid rgba(16,185,129,.35); }

.section-title {
  font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 1.15rem;
  color: var(--text); margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}

input[type=text], input[type=number], select, textarea {
  background: var(--bg3); border: 1.5px solid var(--border2);
  border-radius: var(--rs); padding: 10px 14px;
  color: var(--text); font-family: 'Be Vietnam Pro', sans-serif;
  font-size: .9rem; outline: none; transition: border-color .2s; width: 100%;
}
input:focus, select:focus, textarea:focus { border-color: var(--ga); }

/* =====================================================
   LANDING
   ===================================================== */
#landing {
  background:
    radial-gradient(ellipse at 10% 10%, rgba(124,58,237,.35) 0%, transparent 50%),
    radial-gradient(ellipse at 90% 90%, rgba(14,165,233,.25) 0%, transparent 50%),
    var(--bg);
  align-items: center; justify-content: center;
  padding: 24px; text-align: center; position: relative; overflow: hidden;
}

/* Particle grid */
.particle-grid {
  position: absolute; inset: 0; overflow: hidden; pointer-events: none;
}
.particle-dot {
  position: absolute; width: 2px; height: 2px; border-radius: 50%;
  background: rgba(255,255,255,.3); animation: particleFade linear infinite;
}
@keyframes particleFade {
  0%,100%{opacity:0} 50%{opacity:.8}
}

.land-wrap { max-width: 640px; width: 100%; position: relative; z-index: 5; }

.ai-spark {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 6px 16px; border-radius: 20px; margin-bottom: 20px;
  background: rgba(124,58,237,.2); border: 1px solid rgba(124,58,237,.4);
  font-size: .8rem; font-weight: 700; color: #a78bfa; letter-spacing: 1px;
}
.ai-spark .dot { width: 7px; height: 7px; border-radius: 50%; background: #a78bfa; animation: sparkle 1s ease-in-out infinite; }
@keyframes sparkle { 0%,100%{box-shadow:0 0 0 0 rgba(167,139,250,.6)} 50%{box-shadow:0 0 0 8px rgba(167,139,250,0)} }

.land-title {
  font-family: 'Baloo 2', cursive; font-weight: 900;
  font-size: clamp(2.2rem, 7vw, 3.8rem); line-height: 1.05;
  margin-bottom: 12px;
  background: linear-gradient(135deg, #fff 0%, #c4b5fd 40%, #93c5fd 70%, #6ee7b7 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.land-sub { color: var(--text2); font-size: 1rem; line-height: 1.6; margin-bottom: 32px; }

.feature-pills {
  display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 32px;
}
.fp {
  display: flex; align-items: center; gap: 7px;
  background: var(--card); border: 1px solid var(--border);
  border-radius: 30px; padding: 8px 16px;
  font-size: .82rem; font-weight: 600; color: var(--text2);
}
.fp .icon { font-size: 1.1rem; }

.land-actions { display: flex; gap: 14px; justify-content: center; flex-wrap: wrap; }

/* =====================================================
   CONFIGURATION SCREEN
   ===================================================== */
#config {
  background: var(--bg);
  padding: 0; overflow-y: auto;
}

.config-layout {
  display: grid; grid-template-columns: 280px 1fr;
  min-height: 100vh;
}

/* Left sidebar */
.config-sidebar {
  background: var(--bg2); border-right: 1px solid var(--border);
  padding: 28px 20px; display: flex; flex-direction: column; gap: 24px;
  position: sticky; top: 0; height: 100vh; overflow-y: auto;
}

.sidebar-logo {
  display: flex; align-items: center; gap: 10px;
  font-family: 'Baloo 2', cursive; font-weight: 800;
  font-size: 1.1rem; padding-bottom: 20px; border-bottom: 1px solid var(--border);
}

/* Grade selector */
.grade-tabs {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
}
.grade-tab {
  padding: 12px 8px; border-radius: 12px; border: 2px solid transparent;
  cursor: pointer; text-align: center; transition: all .2s;
  background: var(--bg3);
}
.grade-tab:hover { border-color: rgba(255,255,255,.2); }
.grade-tab.g6.sel { background: rgba(255,107,53,.15); border-color: var(--g6); }
.grade-tab.g7.sel { background: rgba(16,185,129,.15); border-color: var(--g7); }
.grade-tab.g8.sel { background: rgba(59,130,246,.15); border-color: var(--g8); }
.grade-tab.g9.sel { background: rgba(168,85,247,.15); border-color: var(--g9); }
.grade-tab .gt-num {
  font-family: 'Baloo 2', cursive; font-size: 1.5rem; font-weight: 900;
  line-height: 1;
}
.grade-tab .gt-lbl { font-size: .72rem; color: var(--text3); margin-top: 3px; font-weight: 600; }
.grade-tab.sel .gt-lbl { color: var(--text2); }
.grade-tab.g6 .gt-num { color: var(--g6); }
.grade-tab.g7 .gt-num { color: var(--g7); }
.grade-tab.g8 .gt-num { color: var(--g8); }
.grade-tab.g9 .gt-num { color: var(--g9); }

/* Subject grid */
.subject-list { display: flex; flex-direction: column; gap: 6px; }
.subj-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: var(--rs);
  cursor: pointer; transition: all .2s; border: 1px solid transparent;
  background: var(--bg3);
}
.subj-item:hover { background: var(--card); }
.subj-item.sel { background: var(--card2); border-color: var(--ga); }
.subj-item .si-icon { font-size: 1.3rem; }
.subj-item .si-name { font-weight: 700; font-size: .88rem; flex: 1; }
.subj-item .si-check {
  width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--border2);
  display: flex; align-items: center; justify-content: center; font-size: .65rem;
  transition: all .2s;
}
.subj-item.sel .si-check { background: var(--ga); border-color: var(--ga); color: white; }

/* ---- Main config panel ---- */
.config-main { padding: 28px 32px; overflow-y: auto; }

/* AI Generator box */
.ai-generator-box {
  background: linear-gradient(135deg, rgba(124,58,237,.12), rgba(14,165,233,.08));
  border: 1px solid rgba(124,58,237,.3); border-radius: var(--rm);
  padding: 28px; margin-bottom: 24px; position: relative; overflow: hidden;
}
.ai-generator-box::before {
  content: ''; position: absolute; top: -30px; right: -30px;
  width: 140px; height: 140px; border-radius: 50%;
  background: radial-gradient(circle, rgba(124,58,237,.2), transparent 70%);
}

.ai-gen-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  gap: 16px; margin-bottom: 20px;
}
.ai-gen-title {
  font-family: 'Baloo 2', cursive; font-size: 1.3rem; font-weight: 800;
}
.ai-gen-sub { color: var(--text2); font-size: .85rem; margin-top: 4px; line-height: 1.5; }

/* AI Options */
.ai-options {
  display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px;
}
.ai-opt label { display: block; font-size: .78rem; font-weight: 700; color: var(--text3); margin-bottom: 6px; letter-spacing: .5px; text-transform: uppercase; }

/* Topic input */
.topic-area { margin-bottom: 20px; }
.topic-area label { display: block; font-size: .78rem; font-weight: 700; color: var(--text3); margin-bottom: 6px; letter-spacing: .5px; text-transform: uppercase; }
.topic-chips {
  display: flex; flex-wrap: wrap; gap: 7px; margin-top: 10px;
}
.topic-chip {
  padding: 5px 12px; border-radius: 20px; font-size: .78rem; font-weight: 600;
  background: var(--bg3); border: 1px solid var(--border); color: var(--text2);
  cursor: pointer; transition: all .2s;
}
.topic-chip:hover { border-color: var(--ga); color: var(--text); }
.topic-chip.active { background: rgba(124,58,237,.2); border-color: #7c3aed; color: #c4b5fd; }

/* Generate button */
.gen-btn-row { display: flex; align-items: center; gap: 14px; }
.gen-progress {
  flex: 1; height: 6px; background: rgba(255,255,255,.08);
  border-radius: 3px; overflow: hidden; display: none;
}
.gen-progress-bar {
  height: 100%; border-radius: 3px;
  background: linear-gradient(90deg, #7c3aed, #0ea5e9);
  animation: genProgress 2s ease-in-out infinite;
  width: 30%;
}
@keyframes genProgress {
  0%{margin-left:-30%; width:30%}
  100%{margin-left:100%; width:30%}
}

/* Generated questions preview */
.gen-questions-wrap { margin-top: 22px; }
.gen-q-header {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
}
.gen-q-title { font-size: .88rem; font-weight: 700; color: var(--text2); }
.gen-q-list { display: flex; flex-direction: column; gap: 10px; max-height: 360px; overflow-y: auto; padding-right: 4px; }
.gen-q-list::-webkit-scrollbar { width: 4px; }
.gen-q-list::-webkit-scrollbar-thumb { background: var(--card2); border-radius: 2px; }

.gen-q-item {
  background: var(--card); border-radius: var(--rs);
  border: 1px solid var(--border); padding: 14px; position: relative;
  animation: qItemIn .3s ease;
}
@keyframes qItemIn { from{transform:translateY(8px);opacity:0} to{transform:none;opacity:1} }

.gen-q-item .gqi-num {
  font-size: .72rem; font-weight: 800; color: var(--ga);
  text-transform: uppercase; letter-spacing: .5px; margin-bottom: 7px;
  display: flex; align-items: center; gap: 8px;
}
.gqi-ai-tag {
  background: rgba(124,58,237,.2); color: #a78bfa; padding: 1px 7px;
  border-radius: 10px; font-size: .68rem;
}
.gen-q-item .gqi-q { font-weight: 700; font-size: .9rem; margin-bottom: 10px; line-height: 1.4; }
.gqi-opts { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
.gqi-opt {
  font-size: .78rem; color: var(--text2); padding: 4px 8px;
  border-radius: 6px; background: var(--bg3);
  display: flex; align-items: center; gap: 5px;
}
.gqi-opt.correct { color: var(--green2); background: rgba(16,185,129,.12); font-weight: 700; }
.gqi-opt .ol { font-weight: 800; min-width: 16px; }

.gqi-actions {
  position: absolute; top: 10px; right: 10px;
  display: flex; gap: 6px;
}
.gqi-del-btn {
  background: none; border: none; color: var(--text3); cursor: pointer;
  font-size: .9rem; padding: 3px 7px; border-radius: 6px; transition: all .2s;
}
.gqi-del-btn:hover { color: var(--red); background: rgba(239,68,68,.1); }
.gqi-edit-btn {
  background: none; border: none; color: var(--text3); cursor: pointer;
  font-size: .85rem; padding: 3px 7px; border-radius: 6px; transition: all .2s;
}
.gqi-edit-btn:hover { color: var(--gold); background: rgba(251,191,36,.1); }

/* Loading card */
.loading-card {
  background: var(--card); border-radius: var(--rs);
  border: 1px solid rgba(124,58,237,.3); padding: 24px;
  display: flex; flex-direction: column; align-items: center; gap: 14px;
  text-align: center;
}
.loading-spinner {
  width: 48px; height: 48px; border-radius: 50%;
  border: 3px solid var(--border);
  border-top-color: #7c3aed; border-right-color: #0ea5e9;
  animation: spin .9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-weight: 600; color: var(--text2); font-size: .9rem; }
.loading-sub { font-size: .78rem; color: var(--text3); }

/* Empty state */
.empty-state {
  background: var(--card); border-radius: var(--rs);
  border: 2px dashed var(--border2); padding: 36px 24px;
  text-align: center; color: var(--text3);
}
.empty-state .es-icon { font-size: 2.5rem; display: block; margin-bottom: 12px; }
.empty-state .es-title { font-weight: 700; color: var(--text2); font-size: .95rem; margin-bottom: 6px; }
.empty-state .es-sub { font-size: .8rem; line-height: 1.6; }

/* Match settings */
.match-settings {
  background: var(--card); border-radius: var(--r);
  border: 1px solid var(--border); padding: 22px; margin-bottom: 24px;
}
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.setting-field label { display: block; font-size: .78rem; font-weight: 700; color: var(--text3); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .5px; }

.team-color-row { display: flex; align-items: center; gap: 10px; }
.team-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
.team-dot.red { background: var(--red); box-shadow: 0 0 8px var(--red); }
.team-dot.blue { background: var(--blue); box-shadow: 0 0 8px var(--blue); }

/* Start button fixed bottom */
.start-bar {
  position: sticky; bottom: 0; left: 0;
  background: linear-gradient(0deg, var(--bg2) 80%, transparent);
  padding: 20px 32px; display: flex; align-items: center; gap: 16px;
  border-top: 1px solid var(--border);
}
.start-bar-info { flex: 1; }
.start-bar-info .sbi-count {
  font-family: 'Baloo 2', cursive; font-size: 1.5rem; font-weight: 900;
  color: var(--ga);
}
.start-bar-info .sbi-label { font-size: .78rem; color: var(--text3); font-weight: 600; }

/* =====================================================
   GAME SCREEN
   ===================================================== */
#game {
  background:
    linear-gradient(180deg,
      #0a1628 0%, #0d2540 22%,
      #0d3320 45%, #0a2818 60%,
      #071a10 100%
    );
  min-height: 100vh; position: relative; overflow: hidden;
}

/* Stars */
.stars-layer {
  position: absolute; top: 0; left: 0; right: 0; height: 35%;
  pointer-events: none; overflow: hidden;
}
.star {
  position: absolute; width: 2px; height: 2px; border-radius: 50%;
  background: white; animation: starTwinkle linear infinite;
}
@keyframes starTwinkle { 0%,100%{opacity:.2} 50%{opacity:1} }

/* Moon */
.moon {
  position: absolute; top: 14px; right: 50px; width: 50px; height: 50px;
  border-radius: 50%; background: radial-gradient(circle at 35% 35%, #fffde7, #ffd54f);
  box-shadow: 0 0 30px rgba(255,213,79,.4), 0 0 60px rgba(255,213,79,.15);
}

/* Game header */
.game-hdr {
  position: relative; z-index: 30;
  display: flex; align-items: stretch; justify-content: space-between;
  gap: 0; background: rgba(0,0,0,.4); backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255,255,255,.07);
}

.team-panel {
  flex: 1; padding: 14px 20px; display: flex; flex-direction: column;
  align-items: center; gap: 4px;
}
.team-panel.red-panel { background: linear-gradient(135deg, rgba(239,68,68,.12), transparent); }
.team-panel.blue-panel { background: linear-gradient(135deg, transparent, rgba(59,130,246,.12)); }
.tp-name { font-family: 'Baloo 2', cursive; font-size: 1rem; font-weight: 800; color: rgba(255,255,255,.7); }
.tp-score {
  font-family: 'Baloo 2', cursive; font-size: 2.6rem; font-weight: 900;
  line-height: 1; text-shadow: 0 0 20px currentColor;
}
.tp-score.red { color: #fca5a5; }
.tp-score.blue { color: #93c5fd; }

.center-panel {
  padding: 10px 16px; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 4px; min-width: 120px;
}
.cp-badge {
  display: flex; align-items: center; gap: 5px;
  background: rgba(124,58,237,.25); border: 1px solid rgba(124,58,237,.4);
  border-radius: 20px; padding: 3px 10px; font-size: .68rem;
  font-weight: 800; color: #c4b5fd; letter-spacing: .5px;
}
.cp-subject { font-size: .82rem; font-weight: 700; color: rgba(255,255,255,.7); text-align: center; }
.cp-qnum { font-size: .7rem; color: rgba(255,255,255,.4); }

/* Rope zone */
.rope-zone { position: relative; z-index: 20; padding: 8px 20px 4px; }

/* Stickmen arena */
.stick-arena {
  display: flex; justify-content: space-between; align-items: flex-end;
  height: 76px; padding: 0 6px;
}
.stick-team { display: flex; align-items: flex-end; gap: 2px; }
.stick-team.left { flex-direction: row; }
.stick-team.right { flex-direction: row-reverse; }
.stk { width: 30px; height: 62px; }
.stk.ra { animation: swR .55s ease-in-out infinite alternate; transform-origin: 50% 100%; }
.stk.ba { animation: swB .55s ease-in-out infinite alternate; transform-origin: 50% 100%; }
@keyframes swR { from{transform:rotate(-12deg) translateX(3px)} to{transform:rotate(8deg) translateX(-3px)} }
@keyframes swB { from{transform:rotate(12deg) translateX(-3px)} to{transform:rotate(-8deg) translateX(3px)} }

/* Rope track */
.rope-outer { max-width: 680px; margin: 0 auto; }
.rope-track {
  height: 28px; border-radius: 14px; position: relative; overflow: hidden;
  background: rgba(0,0,0,.5); border: 2px solid rgba(255,255,255,.12);
  box-shadow: 0 4px 20px rgba(0,0,0,.6), inset 0 2px 4px rgba(0,0,0,.4);
}
.rr { position:absolute; left:0; top:0; bottom:0; border-radius:14px 0 0 14px; background:linear-gradient(90deg,#7f1d1d,#ef4444,#fca5a5); transition:width .7s cubic-bezier(.34,1.56,.64,1); }
.rb { position:absolute; right:0; top:0; bottom:0; border-radius:0 14px 14px 0; background:linear-gradient(270deg,#1e3a8a,#3b82f6,#93c5fd); transition:width .7s cubic-bezier(.34,1.56,.64,1); }
.rm { position:absolute; left:50%; top:-5px; bottom:-5px; width:3px; background:rgba(255,255,255,.9); transform:translateX(-50%); z-index:5; box-shadow:0 0 8px rgba(255,255,255,.6); }
.rknot {
  position:absolute; top:50%; width:44px; height:44px; border-radius:50%;
  transform:translate(-50%,-50%); z-index:10;
  background:radial-gradient(circle at 35% 30%, #fde68a, #f59e0b, #92400e);
  border:3px solid rgba(255,255,255,.5);
  box-shadow:0 4px 16px rgba(0,0,0,.6), 0 0 20px rgba(251,191,36,.5);
  display:flex; align-items:center; justify-content:center; font-size:1.3rem;
  transition:left .7s cubic-bezier(.34,1.56,.64,1);
}
.rl { position:absolute; left:0; top:-4px; bottom:-4px; width:13%; border-right:2px dashed rgba(239,68,68,.6); background:rgba(239,68,68,.15); border-radius:14px 0 0 14px; z-index:3; }
.rlb { position:absolute; right:0; top:-4px; bottom:-4px; width:13%; border-left:2px dashed rgba(59,130,246,.6); background:rgba(59,130,246,.15); border-radius:0 14px 14px 0; z-index:3; }

/* Score pips */
.pip-row { display:flex; justify-content:space-between; align-items:center; padding:5px 2px; }
.pip-grp { display:flex; gap:5px; }
.pip { width:13px; height:13px; border-radius:50%; border:2px solid rgba(255,255,255,.18); background:rgba(0,0,0,.3); transition:all .3s; }
.pip.pr { background:var(--red2); border-color:var(--red2); box-shadow:0 0 6px var(--red2); }
.pip.pb { background:var(--blue2); border-color:var(--blue2); box-shadow:0 0 6px var(--blue2); }
.pip-vs { font-size:.68rem; color:rgba(255,255,255,.3); font-weight:700; }

/* Ground */
.ground-strip {
  position:relative; z-index:15;
  height:44px; background:linear-gradient(180deg,#14532d,#052e16);
  border-top:3px solid #16a34a;
}
.grass-line {
  position:absolute; top:-9px; left:0; right:0;
  display:flex; justify-content:space-around;
}
.gb { width:0; height:0; border-left:4px solid transparent; border-right:4px solid transparent; border-bottom:13px solid #22c55e; }

/* Question zone */
.q-zone {
  flex:1; position:relative; z-index:25;
  background:linear-gradient(180deg, rgba(7,26,16,.97), rgba(10,16,40,.98));
  border-top:1px solid rgba(255,255,255,.06);
  padding:14px 16px 18px; display:flex; flex-direction:column; gap:11px;
}

/* Turn bar */
.turn-bar {
  align-self:center; display:flex; align-items:center; gap:9px;
  padding:7px 18px; border-radius:30px;
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.09);
  font-size:.82rem; font-weight:700;
}
.tdot { width:9px; height:9px; border-radius:50%; animation:tp .8s ease-in-out infinite; }
.tdot.r { background:var(--red2); box-shadow:0 0 8px var(--red2); }
.tdot.b { background:var(--blue2); box-shadow:0 0 8px var(--blue2); }
@keyframes tp { 0%,100%{transform:scale(1)} 50%{transform:scale(1.6);opacity:.6} }

/* AI tag on question */
.q-ai-indicator {
  align-self:center; display:flex; align-items:center; gap:6px;
  font-size:.72rem; font-weight:700; color:#a78bfa;
  padding:3px 10px; border-radius:10px;
  background:rgba(124,58,237,.15); border:1px solid rgba(124,58,237,.25);
}

/* Timer */
.timer-wrap { height:5px; background:rgba(255,255,255,.08); border-radius:3px; overflow:hidden; }
.timer-fill {
  height:100%; border-radius:3px;
  background:linear-gradient(90deg, var(--green), var(--gold));
  transition:width .1s linear;
}
.timer-fill.warn { background:linear-gradient(90deg, var(--red), #f97316); }

/* Question card */
.q-box {
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
  border-radius:14px; padding:16px 20px;
  font-size:clamp(.9rem,2.5vw,1.08rem); font-weight:700;
  text-align:center; line-height:1.55; min-height:54px;
  display:flex; align-items:center; justify-content:center;
}

/* Answers */
.ans-grid { display:grid; grid-template-columns:1fr 1fr; gap:9px; }
.ans-btn {
  padding:12px 13px; border-radius:13px; border:2px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.06); color:var(--text);
  font-family:'Be Vietnam Pro',sans-serif; font-size:clamp(.8rem,2vw,.92rem);
  font-weight:700; cursor:pointer; transition:all .2s;
  display:flex; align-items:center; gap:9px; text-align:left; line-height:1.35;
}
.ans-btn:hover:not(:disabled) { background:rgba(255,255,255,.14); border-color:rgba(255,255,255,.3); transform:translateY(-2px); }
.ans-btn:disabled { cursor:not-allowed; }
.ab-badge { min-width:26px; height:26px; border-radius:50%; background:rgba(255,255,255,.12); display:flex; align-items:center; justify-content:center; font-size:.75rem; font-weight:900; flex-shrink:0; }
.ans-btn.ok { background:rgba(16,185,129,.3); border-color:var(--green2); animation:aPop .35s ease; }
.ans-btn.ng { background:rgba(239,68,68,.25); border-color:var(--red2); }
.ans-btn.rv { background:rgba(16,185,129,.15); border-color:rgba(16,185,129,.4); }
@keyframes aPop { 0%{transform:scale(1)} 50%{transform:scale(1.04)} 100%{transform:scale(1)} }

/* Rope shake */
@keyframes ropeShake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-9px)} 40%{transform:translateX(11px)} 60%{transform:translateX(-7px)} 80%{transform:translateX(7px)} }
.shaking { animation:ropeShake .45s ease; }

/* =====================================================
   FEEDBACK OVERLAY
   ===================================================== */
.fb-overlay {
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  z-index:200; pointer-events:none; opacity:0; transition:opacity .2s;
}
.fb-overlay.show { opacity:1; }
.fb-box {
  padding:18px 40px; border-radius:18px;
  font-family:'Baloo 2',cursive; font-size:clamp(1.3rem,5vw,2rem); font-weight:900;
  text-align:center; box-shadow:0 8px 40px rgba(0,0,0,.7);
  animation:fbIn .35s cubic-bezier(.34,1.56,.64,1);
}
.fb-box.ok { background:linear-gradient(135deg,#065f46,var(--green)); color:white; }
.fb-box.ng { background:linear-gradient(135deg,#7f1d1d,var(--red)); color:white; }
@keyframes fbIn { from{transform:scale(.3);opacity:0} to{transform:scale(1);opacity:1} }

/* =====================================================
   AI GENERATING OVERLAY (in-game)
   ===================================================== */
.ai-gen-overlay {
  position:fixed; inset:0; z-index:300;
  display:none; flex-direction:column; align-items:center; justify-content:center;
  background:rgba(13,15,26,.92); backdrop-filter:blur(12px);
  text-align:center; gap:24px;
  padding:40px;
}
.ai-gen-overlay.show { display:flex; }
.ago-spinner { position:relative; width:80px; height:80px; }
.ago-ring {
  position:absolute; inset:0; border-radius:50%; border:3px solid transparent;
  animation:ringPulse 1.2s ease-in-out infinite;
}
.ago-ring:nth-child(1) { border-top-color:#7c3aed; animation-delay:0s; }
.ago-ring:nth-child(2) { inset:10px; border-top-color:#0ea5e9; animation-delay:.15s; }
.ago-ring:nth-child(3) { inset:20px; border-top-color:#10b981; animation-delay:.3s; }
@keyframes ringPulse { to{transform:rotate(360deg)} }
.ago-icon { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:1.8rem; }
.ago-title { font-family:'Baloo 2',cursive; font-size:1.6rem; font-weight:800; }
.ago-status { color:var(--text2); font-size:.9rem; max-width:320px; line-height:1.6; }
.ago-progress {
  width:280px; height:6px; background:rgba(255,255,255,.1); border-radius:3px; overflow:hidden;
}
.ago-bar {
  height:100%; background:linear-gradient(90deg,#7c3aed,#0ea5e9,#10b981);
  border-radius:3px; animation:agoBar 2s ease-in-out infinite; width:0%;
  transition:width .5s ease;
}
@keyframes agoBar {
  0%{background-position:0% 50%}
  100%{background-position:200% 50%}
}
.ago-tip { font-size:.78rem; color:var(--text3); max-width:280px; }

/* =====================================================
   WIN SCREEN
   ===================================================== */
#win {
  background:radial-gradient(ellipse at center, rgba(124,58,237,.3), var(--bg));
  align-items:center; justify-content:center; text-align:center; padding:40px 24px;
  position:relative; overflow:hidden;
}
.cp-layer { position:fixed; inset:0; pointer-events:none; z-index:0; }
.cp-p { position:absolute; top:-40px; border-radius:3px; animation:cpf linear forwards; }
@keyframes cpf { to{transform:translateY(110vh) rotate(720deg);opacity:0} }
.win-wrap { position:relative; z-index:5; max-width:500px; width:100%; }
.win-trophy { font-size:5.5rem; display:block; margin-bottom:14px; animation:trophyIn .6s cubic-bezier(.34,1.56,.64,1); }
@keyframes trophyIn { from{transform:scale(0) rotate(-20deg);opacity:0} to{transform:scale(1) rotate(0);opacity:1} }
.win-hl { font-family:'Baloo 2',cursive; font-size:1.2rem; font-weight:700; color:var(--text2); margin-bottom:8px; }
.win-name { font-family:'Baloo 2',cursive; font-size:clamp(2rem,8vw,3.5rem); font-weight:900; margin-bottom:6px; animation:wng 1.5s ease infinite alternate; }
.win-name.r { color:var(--red2); } .win-name.b { color:var(--blue2); }
@keyframes wng { from{filter:brightness(1)} to{filter:brightness(1.5) drop-shadow(0 0 16px currentColor)} }
.win-score { display:flex; align-items:center; gap:18px; justify-content:center; font-family:'Baloo 2',cursive; font-size:2.5rem; font-weight:900; margin-bottom:28px; }
.win-score .wsr { color:var(--red2); } .win-score .wsb { color:var(--blue2); } .win-score .wsvs { color:var(--text3); font-size:1.3rem; }
.win-stats { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:30px; }
.ws { background:rgba(255,255,255,.06); border-radius:12px; border:1px solid var(--border); padding:14px; }
.ws .wsv { font-family:'Baloo 2',cursive; font-size:1.7rem; font-weight:900; color:var(--gold); }
.ws .wsl { font-size:.7rem; color:var(--text3); font-weight:600; margin-top:3px; }
.win-btns { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

/* =====================================================
   RESPONSIVE
   ===================================================== */
@media (max-width: 768px) {
  .config-layout { grid-template-columns: 1fr; }
  .config-sidebar { position:static; height:auto; }
  .grade-tabs { grid-template-columns:repeat(4,1fr); }
  .subject-list { flex-direction:row; flex-wrap:wrap; }
  .subj-item { flex:1; min-width:120px; flex-direction:column; text-align:center; }
  .ai-options { grid-template-columns:1fr; }
  .settings-grid { grid-template-columns:1fr; }
  .ans-grid { grid-template-columns:1fr; }
  .gqi-opts { grid-template-columns:1fr; }
  .config-main { padding:16px; }
}
@media (max-width: 480px) {
  .grade-tabs { grid-template-columns:1fr 1fr; }
  .feature-pills { gap:7px; }
}

/* API Key section */
.api-key-row {
  background: rgba(0,0,0,.25); border-radius: 12px;
  border: 1px solid rgba(255,215,0,.2); padding: 16px;
  margin-bottom: 18px;
}
.api-key-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
}
.api-key-label { font-size: .82rem; font-weight: 800; color: var(--gold); letter-spacing: .4px; }
.api-key-link {
  font-size: .75rem; color: #60a5fa; text-decoration: none; font-weight: 600;
}
.api-key-link:hover { text-decoration: underline; }
.api-key-input-wrap {
  display: flex; gap: 8px; align-items: center;
}
.api-key-input-wrap input {
  flex: 1; font-size: .85rem; letter-spacing: .5px;
  border-color: rgba(255,215,0,.25);
}
.api-key-input-wrap input:focus { border-color: var(--gold); }
.api-key-input-wrap input.key-ok { border-color: var(--green2); }
.api-key-input-wrap input.key-err { border-color: var(--red2); }
.api-key-toggle {
  background: rgba(255,255,255,.08); border: 1px solid var(--border2);
  border-radius: 8px; padding: 8px 11px; cursor: pointer; font-size: 1rem;
  transition: background .2s; flex-shrink: 0;
}
.api-key-toggle:hover { background: rgba(255,255,255,.15); }
.api-key-hint { font-size: .73rem; color: var(--text3); margin-top: 7px; line-height: 1.5; }
.api-key-hint.ok { color: var(--green2); }
.api-key-hint.err { color: var(--red2); }

/* ‚îÄ‚îÄ Developer Card ‚îÄ‚îÄ */
.dev-card {
  margin-top: 36px; padding: 20px 24px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.09);
  border-radius: 20px; display: flex;
  align-items: center; gap: 16px;
  backdrop-filter: blur(8px);
  cursor: pointer; transition: all .25s;
  max-width: 440px; margin-left: auto; margin-right: auto;
  margin-top: 28px;
}
.dev-card:hover {
  background: rgba(255,255,255,.08);
  border-color: rgba(167,139,250,.45);
  transform: translateY(-3px);
  box-shadow: 0 12px 32px rgba(124,58,237,.25);
}
.dev-avatar {
  width: 56px; height: 56px; border-radius: 50%; flex-shrink: 0;
  background: linear-gradient(135deg, #7c3aed, #0ea5e9, #10b981);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.6rem; box-shadow: 0 0 0 3px rgba(167,139,250,.35);
  animation: avatarPulse 3s ease-in-out infinite;
}
@keyframes avatarPulse {
  0%,100%{ box-shadow: 0 0 0 3px rgba(167,139,250,.35); }
  50%    { box-shadow: 0 0 0 6px rgba(167,139,250,.1), 0 0 20px rgba(124,58,237,.3); }
}
.dev-info { flex: 1; text-align: left; }
.dev-name {
  font-family: 'Baloo 2', cursive; font-weight: 800;
  font-size: 1rem; color: var(--text); line-height: 1.2; margin-bottom: 3px;
}
.dev-role {
  font-size: .78rem; color: #a78bfa; font-weight: 700;
  display: flex; align-items: center; gap: 5px; margin-bottom: 3px;
}
.dev-school { font-size: .72rem; color: var(--text3); line-height: 1.4; }
.dev-arrow { color: var(--text3); font-size: 1.1rem; flex-shrink: 0; transition: transform .2s; }
.dev-card:hover .dev-arrow { transform: translateX(4px); color: #a78bfa; }

/* ‚îÄ‚îÄ Developer Modal ‚îÄ‚îÄ */
.dev-modal-backdrop {
  position: fixed; inset: 0; z-index: 600;
  background: rgba(0,0,0,.75); backdrop-filter: blur(10px);
  display: none; align-items: center; justify-content: center;
  padding: 20px;
  animation: fadeIn .2s ease;
}
.dev-modal-backdrop.open { display: flex; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

.dev-modal {
  background: linear-gradient(160deg, #1a1d35 0%, #141630 60%, #0d1128 100%);
  border: 1px solid rgba(167,139,250,.25);
  border-radius: 28px; padding: 40px 36px;
  max-width: 480px; width: 100%; position: relative;
  box-shadow: 0 24px 80px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.05);
  animation: modalIn .35s cubic-bezier(.34,1.56,.64,1);
}
@keyframes modalIn { from{transform:scale(.85) translateY(20px);opacity:0} to{transform:none;opacity:1} }

.modal-close {
  position: absolute; top: 16px; right: 16px;
  background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%; width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 1rem; color: var(--text2); transition: all .2s;
}
.modal-close:hover { background: rgba(255,255,255,.16); color: var(--text); }

.modal-avatar-wrap {
  display: flex; flex-direction: column; align-items: center; margin-bottom: 24px;
}
.modal-avatar {
  width: 90px; height: 90px; border-radius: 50%;
  background: linear-gradient(135deg, #7c3aed, #0ea5e9, #10b981);
  display: flex; align-items: center; justify-content: center;
  font-size: 2.8rem; margin-bottom: 14px;
  box-shadow: 0 0 0 4px rgba(167,139,250,.3), 0 8px 32px rgba(124,58,237,.4);
  animation: avatarPulse 3s ease-in-out infinite;
}
.modal-name {
  font-family: 'Baloo 2', cursive; font-size: 1.5rem; font-weight: 900;
  text-align: center; margin-bottom: 6px;
  background: linear-gradient(135deg, #fff 0%, #c4b5fd 50%, #93c5fd 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.modal-badge-row {
  display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;
}
.modal-badge {
  padding: 4px 12px; border-radius: 20px; font-size: .75rem; font-weight: 700;
}
.mb-purple { background: rgba(124,58,237,.2); color: #c4b5fd; border: 1px solid rgba(124,58,237,.3); }
.mb-blue   { background: rgba(59,130,246,.2);  color: #93c5fd;  border: 1px solid rgba(59,130,246,.3); }
.mb-green  { background: rgba(16,185,129,.2);  color: #6ee7b7;  border: 1px solid rgba(16,185,129,.3); }
.mb-gemini {
  background: linear-gradient(135deg, rgba(66,133,244,.2), rgba(52,168,83,.15), rgba(251,188,5,.15), rgba(234,67,53,.15));
  color: #93c5fd; border: 1px solid rgba(66,133,244,.4);
  position: relative; overflow: hidden;
}
.mb-gemini::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
  animation: geminiShine 2.5s ease-in-out infinite;
}
@keyframes geminiShine {
  0%{ transform: translateX(-100%); }
  100%{ transform: translateX(200%); }
}

.modal-divider {
  height: 1px; background: linear-gradient(90deg, transparent, rgba(167,139,250,.3), transparent);
  margin: 22px 0;
}

.modal-info-grid {
  display: flex; flex-direction: column; gap: 12px; margin-bottom: 22px;
}
.modal-info-row {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 12px 14px; border-radius: 12px;
  background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.06);
}
.mrow-icon { font-size: 1.3rem; flex-shrink: 0; margin-top: 1px; }
.mrow-body {}
.mrow-label { font-size: .7rem; font-weight: 800; color: var(--text3); letter-spacing: .5px; text-transform: uppercase; margin-bottom: 3px; }
.mrow-value { font-size: .9rem; font-weight: 700; color: var(--text); line-height: 1.4; }
.mrow-value.highlight { color: #c4b5fd; }

.modal-quote {
  background: linear-gradient(135deg, rgba(124,58,237,.1), rgba(14,165,233,.07));
  border: 1px solid rgba(124,58,237,.2); border-left: 3px solid #7c3aed;
  border-radius: 12px; padding: 14px 16px;
  font-size: .85rem; color: var(--text2); line-height: 1.6;
  font-style: italic;
}

.modal-footer {
  margin-top: 22px; text-align: center;
  font-size: .72rem; color: var(--text3); line-height: 1.8;
}
.modal-footer strong { color: #a78bfa; }
</style>
</head>
<body>

<!-- ================================================================
     SCREEN 1 ¬∑ LANDING
     ================================================================ -->
<div id="landing" class="screen active">
  <div class="particle-grid" id="pgrid"></div>
  <div class="land-wrap">
    <div class="ai-spark">
      <div class="dot"></div>
      ‚ú¶ AI-POWERED ¬∑ CLAUDE SONNET
    </div>
    <h1 class="land-title">K√©o Co<br>Ki·∫øn Th·ª©c ‚ú¶ AI</h1>
    <p class="land-sub">AI t·ª± ƒë·ªông t·∫°o c√¢u h·ªèi tr·∫Øc nghi·ªám theo ƒë√∫ng m√¥n h·ªçc,<br>kh·ªëi l·ªõp v√† ch·ªß ƒë·ªÅ b·∫°n ch·ªçn ‚Äî ch·ªâ trong v√†i gi√¢y.</p>
    <div class="feature-pills">
      <div class="fp"><span class="icon">ü§ñ</span>AI sinh c√¢u h·ªèi t·ª± ƒë·ªông</div>
      <div class="fp"><span class="icon">üìö</span>L·ªõp 6 ‚Äì 9 ¬∑ 8 m√¥n</div>
      <div class="fp"><span class="icon">üéØ</span>ƒê√∫ng ch∆∞∆°ng tr√¨nh THCS</div>
      <div class="fp"><span class="icon">‚ö°</span>Sinh ngay trong gi√¢y l√°t</div>
      <div class="fp"><span class="icon">‚úèÔ∏è</span>Ch·ªânh s·ª≠a linh ho·∫°t</div>
      <div class="fp"><span class="icon">üèÜ</span>K√©o co si√™u s√¥i ƒë·ªông</div>
    </div>
    <div class="land-actions">
      <button class="btn btn-ai btn-xl" onclick="goTo('config')">‚ú¶ T·∫°o c√¢u h·ªèi v·ªõi AI</button>
      <button class="btn btn-ghost btn-lg" onclick="goTo('config')">‚öô C√†i ƒë·∫∑t tr·∫≠n ƒë·∫•u</button>
    </div>

    <!-- Developer Card -->
    <div class="dev-card" onclick="openDevModal()" title="Xem th√¥ng tin ng∆∞·ªùi ph√°t tri·ªÉn">
      <div class="dev-avatar">üë©‚Äçüè´</div>
      <div class="dev-info">
        <div class="dev-name">C√¥ Hu·ª≥nh Th·ªã Th√πy D∆∞∆°ng</div>
        <div class="dev-role">üî¨ Gi√°o vi√™n Khoa h·ªçc t·ª± nhi√™n</div>
        <div class="dev-school">THCS L√Ω T·ª± Tr·ªçng ¬∑ Long Hoa, T√¢y Ninh</div>
        <div style="margin-top:6px;"><span style="display:inline-flex;align-items:center;gap:5px;font-size:.7rem;font-weight:800;padding:2px 9px;border-radius:10px;background:linear-gradient(90deg,rgba(66,133,244,.2),rgba(52,168,83,.15),rgba(251,188,5,.15),rgba(234,67,53,.15));border:1px solid rgba(66,133,244,.4);color:#93c5fd;">‚ú¶ Gemini Educator</span></div>
      </div>
      <div class="dev-arrow">‚Ä∫</div>
    </div>
  </div>
</div>


<!-- ================================================================
     DEVELOPER MODAL
     ================================================================ -->
<div class="dev-modal-backdrop" id="dev-modal" onclick="closeDevModal(event)">
  <div class="dev-modal">
    <button class="modal-close" onclick="closeDevModal()">‚úï</button>

    <div class="modal-avatar-wrap">
      <div class="modal-avatar">üë©‚Äçüè´</div>
      <div class="modal-name">Hu·ª≥nh Th·ªã Th√πy D∆∞∆°ng</div>
      <div class="modal-badge-row">
        <span class="modal-badge mb-purple">‚ú¶ Nh√† ph√°t tri·ªÉn</span>
        <span class="modal-badge mb-gemini">‚ú¶ Gemini Educator</span>
        <span class="modal-badge mb-blue">üî¨ KHTN</span>
        <span class="modal-badge mb-green">üè´ THCS</span>
      </div>
    </div>

    <div class="modal-divider"></div>

    <div class="modal-info-grid">
      <div class="modal-info-row">
        <span class="mrow-icon">üë©‚Äçüè´</span>
        <div class="mrow-body">
          <div class="mrow-label">Ch·ª©c v·ª•</div>
          <div class="mrow-value highlight">Gi√°o vi√™n Khoa h·ªçc t·ª± nhi√™n</div>
        </div>
      </div>
      <div class="modal-info-row">
        <span class="mrow-icon" style="font-size:1.2rem;">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" fill="none"/>
            <path d="M12 3.5c4.69 0 8.5 3.81 8.5 8.5S16.69 20.5 12 20.5 3.5 16.69 3.5 12 7.31 3.5 12 3.5z" fill="none" stroke="#4285F4" stroke-width="1.5"/>
            <path d="M8 12h8M12 8l4 4-4 4" stroke="#4285F4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <div class="mrow-body">
          <div class="mrow-label">Ch·ª©ng nh·∫≠n Google</div>
          <div class="mrow-value" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <span style="display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:.8rem;font-weight:800;background:linear-gradient(90deg,rgba(66,133,244,.18),rgba(52,168,83,.14),rgba(251,188,5,.14),rgba(234,67,53,.14));border:1px solid rgba(66,133,244,.4);color:#93c5fd;position:relative;overflow:hidden;">
              <span style="font-size:.95rem;">‚ú¶</span> Gemini Educator
              <span style="position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);animation:geminiShine 2.5s ease-in-out infinite;"></span>
            </span>
            <span style="font-size:.75rem;color:var(--text3);">Google for Education</span>
          </div>
        </div>
      </div>
      <div class="modal-info-row">
        <span class="mrow-icon">üè´</span>
        <div class="mrow-body">
          <div class="mrow-label">ƒê∆°n v·ªã c√¥ng t√°c</div>
          <div class="mrow-value">Tr∆∞·ªùng THCS L√Ω T·ª± Tr·ªçng</div>
        </div>
      </div>
      <div class="modal-info-row">
        <span class="mrow-icon">üìç</span>
        <div class="mrow-body">
          <div class="mrow-label">ƒê·ªãa ƒëi·ªÉm</div>
          <div class="mrow-value">Ph∆∞·ªùng Long Hoa, th√†nh ph·ªë T√¢y Ninh<br>t·ªânh T√¢y Ninh</div>
        </div>
      </div>
      <div class="modal-info-row">
        <span class="mrow-icon">ü§ñ</span>
        <div class="mrow-body">
          <div class="mrow-label">C√¥ng c·ª• ph√°t tri·ªÉn</div>
          <div class="mrow-value">Claude AI (Anthropic) ¬∑ Web Audio API<br>HTML5 ¬∑ CSS3 ¬∑ JavaScript</div>
        </div>
      </div>
    </div>

    <div class="modal-quote">
      "·ª®ng d·ª•ng ƒë∆∞·ª£c x√¢y d·ª±ng v·ªõi mong mu·ªën mang l·∫°i nh·ªØng ti·∫øt h·ªçc s√¥i ƒë·ªông,
      h√†o h·ª©ng cho h·ªçc sinh THCS ‚Äî n∆°i ki·∫øn th·ª©c v√† ni·ªÅm vui ƒë∆∞·ª£c k·∫øt h·ª£p
      qua t·ª´ng c√¢u h·ªèi, t·ª´ng l∆∞·ª£t k√©o co ƒë·∫ßy k·ªãch t√≠nh."
    </div>

    <div class="modal-footer">
      Ph√°t tri·ªÉn nƒÉm <strong>2025</strong> ¬∑ D√†nh cho gi√°o vi√™n ƒë·ªïi m·ªõi<br>
      ü™¢ <strong>K√©o Co Ki·∫øn Th·ª©c ‚Äì AI Edition</strong>
    </div>
  </div>
</div>

<!-- ================================================================
     SCREEN 2 ¬∑ CONFIG
     ================================================================ -->
<div id="config" class="screen">
  <div class="config-layout">

    <!-- SIDEBAR -->
    <div class="config-sidebar">
      <div class="sidebar-logo">
        ü™¢ <span style="background:linear-gradient(135deg,#c4b5fd,#93c5fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">K√©o Co AI</span>
      </div>

      <!-- Grade -->
      <div>
        <div class="section-title" style="font-size:1rem;">üè´ Kh·ªëi l·ªõp</div>
        <div class="grade-tabs">
          <div class="grade-tab g6 sel" id="gt-6" onclick="selGrade(6)">
            <div class="gt-num">6</div><div class="gt-lbl">L·ªõp 6</div>
          </div>
          <div class="grade-tab g7" id="gt-7" onclick="selGrade(7)">
            <div class="gt-num">7</div><div class="gt-lbl">L·ªõp 7</div>
          </div>
          <div class="grade-tab g8" id="gt-8" onclick="selGrade(8)">
            <div class="gt-num">8</div><div class="gt-lbl">L·ªõp 8</div>
          </div>
          <div class="grade-tab g9" id="gt-9" onclick="selGrade(9)">
            <div class="gt-num">9</div><div class="gt-lbl">L·ªõp 9</div>
          </div>
        </div>
      </div>

      <!-- Subject -->
      <div>
        <div class="section-title" style="font-size:1rem;">üìñ M√¥n h·ªçc</div>
        <div class="subject-list" id="subject-list"></div>
      </div>

      <!-- Back -->
      <div style="margin-top:auto;">
        <button class="btn btn-ghost" style="width:100%;" onclick="goTo('landing')">‚Üê Trang ch·ªß</button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="config-main">

      <!-- AI Generator -->
      <div class="ai-generator-box">
        <div class="ai-gen-header">
          <div>
            <div class="ai-gen-title">‚ú¶ AI Sinh C√¢u H·ªèi</div>
            <div class="ai-gen-sub">AI s·∫Ω t·∫°o c√¢u h·ªèi tr·∫Øc nghi·ªám 4 ƒë√°p √°n ƒë√∫ng ch∆∞∆°ng tr√¨nh THCS,<br>ph√π h·ª£p ƒë√∫ng m√¥n v√† kh·ªëi l·ªõp b·∫°n ch·ªçn.</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end; flex-shrink:0;">
            <span class="badge badge-ai">‚ú¶ Gemini AI</span>
            <span class="badge badge-new">‚ú® T·ª± ƒë·ªông</span>
          </div>
        </div>

        <!-- AI Options -->
        <div class="ai-options">
          <div class="ai-opt">
            <label>üìä S·ªë c√¢u h·ªèi c·∫ßn t·∫°o</label>
            <select id="ai-count">
              <option value="5">5 c√¢u</option>
              <option value="8" selected>8 c√¢u</option>
              <option value="10">10 c√¢u</option>
              <option value="12">12 c√¢u</option>
              <option value="15">15 c√¢u</option>
            </select>
          </div>
          <div class="ai-opt">
            <label>üéØ M·ª©c ƒë·ªô kh√≥</label>
            <select id="ai-diff">
              <option value="d·ªÖ">üü¢ D·ªÖ ‚Äî Nh·∫≠n bi·∫øt</option>
              <option value="trung b√¨nh" selected>üü° Trung b√¨nh ‚Äî Hi·ªÉu</option>
              <option value="kh√≥">üî¥ Kh√≥ ‚Äî V·∫≠n d·ª•ng</option>
              <option value="h·ªón h·ª£p">üé≤ H·ªón h·ª£p c√°c m·ª©c</option>
            </select>
          </div>
        </div>

        <div class="topic-area">
          <label>üìå Ch·ªß ƒë·ªÅ / Ch∆∞∆°ng c·ª• th·ªÉ (tu·ª≥ ch·ªçn)</label>
          <input type="text" id="ai-topic" placeholder="VD: Ph√¢n s·ªë, Chi·∫øn tranh th·∫ø gi·ªõi th·ª© 2, T·∫ø b√†o...">
          <div class="topic-chips" id="topic-chips"></div>
        </div>

        <!-- API Key -->
        <div class="api-key-row">
          <div class="api-key-header">
            <span class="api-key-label">üîë Google Gemini API Key</span>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-key-link">L·∫•y key mi·ªÖn ph√≠ t·∫°i AI Studio ‚Üó</a>
          </div>
          <div class="api-key-input-wrap">
            <input type="password" id="api-key-input" placeholder="AIza..." autocomplete="off" oninput="onKeyInput()">
            <button class="api-key-toggle" onclick="toggleKeyVis()" title="Hi·ªán/·∫©n key">üëÅ</button>
          </div>
          <div class="api-key-hint" id="api-key-hint">Nh·∫≠p Google Gemini API Key (mi·ªÖn ph√≠). Key ch·ªâ l∆∞u tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.</div>
        </div>

        <div class="gen-btn-row">
          <button class="btn btn-ai btn-lg" id="gen-btn" onclick="generateQuestions()" disabled>
            ‚ú¶ T·∫°o c√¢u h·ªèi v·ªõi AI
          </button>
          <div class="gen-progress" id="gen-progress">
            <div class="gen-progress-bar"></div>
          </div>
        </div>

        <!-- Generated questions -->
        <div class="gen-questions-wrap" id="gen-qs-wrap" style="display:none;">
          <div class="gen-q-header">
            <div class="gen-q-title">‚ú¶ C√¢u h·ªèi ƒë√£ t·∫°o (<span id="gen-count">0</span>)</div>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-ghost btn-sm" onclick="clearGenerated()">üóë X√≥a t·∫•t c·∫£</button>
              <button class="btn btn-ai btn-sm" onclick="generateMore()">+ T·∫°o th√™m</button>
            </div>
          </div>
          <div class="gen-q-list" id="gen-q-list"></div>
        </div>

        <!-- Empty state -->
        <div class="empty-state" id="empty-state" style="margin-top:20px;">
          <span class="es-icon">ü§ñ</span>
          <div class="es-title">AI ch∆∞a t·∫°o c√¢u h·ªèi n√†o</div>
          <div class="es-sub">Ch·ªçn m√¥n h·ªçc, kh·ªëi l·ªõp v√† nh·∫•n <strong>"T·∫°o c√¢u h·ªèi v·ªõi AI"</strong><br>ƒë·ªÉ AI t·ª± ƒë·ªông sinh c√¢u h·ªèi ph√π h·ª£p ch∆∞∆°ng tr√¨nh THCS.</div>
        </div>
      </div>

      <!-- Match settings -->
      <div class="match-settings">
        <div class="section-title">‚öôÔ∏è C√†i ƒë·∫∑t tr·∫≠n ƒë·∫•u</div>
        <div class="settings-grid">
          <div class="setting-field">
            <label>üî¥ T√™n ƒê·ªôi ƒê·ªè</label>
            <div class="team-color-row">
              <div class="team-dot red"></div>
              <input type="text" id="nm-red" value="ƒê·ªôi ƒê·ªè" placeholder="T√™n ƒë·ªôi ƒë·ªè...">
            </div>
          </div>
          <div class="setting-field">
            <label>üîµ T√™n ƒê·ªôi Xanh</label>
            <div class="team-color-row">
              <div class="team-dot blue"></div>
              <input type="text" id="nm-blue" value="ƒê·ªôi Xanh" placeholder="T√™n ƒë·ªôi xanh...">
            </div>
          </div>
          <div class="setting-field">
            <label>üèÜ C√¢u ƒë√∫ng ƒë·ªÉ th·∫Øng</label>
            <select id="win-n">
              <option value="3">3 c√¢u</option>
              <option value="5" selected>5 c√¢u</option>
              <option value="7">7 c√¢u</option>
              <option value="10">10 c√¢u</option>
            </select>
          </div>
          <div class="setting-field">
            <label>‚è± Th·ªùi gian / c√¢u</label>
            <select id="time-n">
              <option value="0">Kh√¥ng gi·ªõi h·∫°n</option>
              <option value="15">15 gi√¢y</option>
              <option value="20" selected>20 gi√¢y</option>
              <option value="30">30 gi√¢y</option>
              <option value="45">45 gi√¢y</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Start bar -->
      <div class="start-bar">
        <div class="start-bar-info">
          <div class="sbi-count" id="sbi-count">0</div>
          <div class="sbi-label">c√¢u h·ªèi s·∫µn s√†ng</div>
        </div>
        <button class="btn btn-primary btn-xl" id="start-btn" onclick="launchGame()" disabled>
          üéÆ B·∫Øt ƒë·∫ßu K√©o Co!
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================================================================
     SCREEN 3 ¬∑ GAME
     ================================================================ -->
<div id="game" class="screen">
  <div class="stars-layer" id="stars-layer"><div class="moon"></div></div>

  <div class="game-hdr">
    <div class="team-panel red-panel">
      <div class="tp-name" id="tp-rname">ƒê·ªôi ƒê·ªè</div>
      <div class="tp-score red" id="tp-rscore">0</div>
    </div>
    <div class="center-panel">
      <div class="cp-badge">‚ú¶ AI</div>
      <div class="cp-subject" id="cp-subject">To√°n ¬∑ L6</div>
      <div class="cp-qnum" id="cp-qnum">C√¢u 1</div>
    </div>
    <div class="team-panel blue-panel">
      <div class="tp-name" id="tp-bname">ƒê·ªôi Xanh</div>
      <div class="tp-score blue" id="tp-bscore">0</div>
    </div>
  </div>

  <div class="rope-zone">
    <div class="stick-arena">
      <div class="stick-team left" id="st-red"></div>
      <div class="stick-team right" id="st-blue"></div>
    </div>
    <div class="rope-outer">
      <div class="rope-track" id="rope-track">
        <div class="rr" id="rr"></div>
        <div class="rb" id="rb"></div>
        <div class="rl"></div><div class="rlb"></div>
        <div class="rm"></div>
        <div class="rknot" id="rknot">ü™¢</div>
      </div>
      <div class="pip-row">
        <div class="pip-grp" id="pip-r"></div>
        <div class="pip-vs">VS</div>
        <div class="pip-grp" id="pip-b"></div>
      </div>
    </div>
  </div>

  <div class="ground-strip"><div class="grass-line" id="grass-line"></div></div>

  <div class="q-zone">
    <div class="turn-bar" id="turn-bar">
      <div class="tdot r" id="tdot"></div>
      <span id="tlabel">L∆∞·ª£t ƒê·ªôi ƒê·ªè</span>
    </div>
    <div class="q-ai-indicator" id="q-ai-ind">
      ‚ú¶ C√¢u h·ªèi do AI t·∫°o
    </div>
    <div class="timer-wrap" id="timer-wrap" style="display:none">
      <div class="timer-fill" id="timer-fill"></div>
    </div>
    <div class="q-box" id="q-box">ƒêang chu·∫©n b·ªã...</div>
    <div class="ans-grid" id="ans-grid"></div>
  </div>
</div>

<!-- ================================================================
     SCREEN 4 ¬∑ WIN
     ================================================================ -->
<div id="win" class="screen">
  <div class="cp-layer" id="cp-layer"></div>
  <div class="win-wrap">
    <span class="win-trophy">üèÜ</span>
    <div class="win-hl">üéâ Tr·∫≠n ƒë·∫•u k·∫øt th√∫c!</div>
    <div class="win-name" id="win-name">ƒê·ªôi ƒê·ªè</div>
    <div class="win-score">
      <span class="wsr" id="win-rs">0</span>
      <span class="wsvs">‚Äì</span>
      <span class="wsb" id="win-bs">0</span>
    </div>
    <div class="win-stats">
      <div class="ws"><div class="wsv" id="ws-total">0</div><div class="wsl">T·ªïng c√¢u</div></div>
      <div class="ws"><div class="wsv" id="ws-cor">0</div><div class="wsl">C√¢u ƒë√∫ng</div></div>
      <div class="ws"><div class="wsv" id="ws-pct">0%</div><div class="wsl">T·ªâ l·ªá ƒë√∫ng</div></div>
    </div>
    <div class="win-btns">
      <button class="btn btn-gold btn-lg" onclick="restartGame()">üîÑ Ch∆°i l·∫°i</button>
      <button class="btn btn-ai btn-lg" onclick="regenAndPlay()">‚ú¶ AI t·∫°o c√¢u m·ªõi</button>
      <button class="btn btn-ghost btn-lg" onclick="goTo('config')">‚öô C√†i ƒë·∫∑t</button>
    </div>
  </div>
</div>

<!-- AI Generating overlay -->
<div class="ai-gen-overlay" id="ai-overlay">
  <div class="ago-spinner">
    <div class="ago-ring"></div>
    <div class="ago-ring"></div>
    <div class="ago-ring"></div>
    <div class="ago-icon">ü§ñ</div>
  </div>
  <div class="ago-title">AI ƒëang t·∫°o c√¢u h·ªèi...</div>
  <div class="ago-status" id="ago-status">ƒêang ph√¢n t√≠ch m√¥n h·ªçc v√† kh·ªëi l·ªõp ƒë·ªÉ t·∫°o c√¢u h·ªèi ph√π h·ª£p nh·∫•t...</div>
  <div class="ago-progress"><div class="ago-bar" id="ago-bar"></div></div>
  <div class="ago-tip">üí° Gemini AI s·∫Ω t·∫°o c√¢u h·ªèi ƒë√∫ng ch∆∞∆°ng tr√¨nh THCS hi·ªán h√†nh</div>
</div>

<!-- Feedback overlay -->
<div class="fb-overlay" id="fb-ov">
  <div class="fb-box" id="fb-box"></div>
</div>

<!-- ================================================================
     JAVASCRIPT
     ================================================================ -->
<script>
/* ============================================================
   SUBJECT DATA
   ============================================================ */
const SUBJECTS = {
  6: [
    { name:"To√°n h·ªçc", icon:"üìê" },
    { name:"Ng·ªØ VƒÉn", icon:"üìñ" },
    { name:"Khoa h·ªçc t·ª± nhi√™n", icon:"üî¨" },
    { name:"L·ªãch s·ª≠ & ƒê·ªãa l√Ω", icon:"üó∫Ô∏è" },
    { name:"GDCD", icon:"‚öñÔ∏è" },
    { name:"Ti·∫øng Anh", icon:"üåç" }
  ],
  7: [
    { name:"To√°n h·ªçc", icon:"üìê" },
    { name:"Ng·ªØ VƒÉn", icon:"üìñ" },
    { name:"Khoa h·ªçc t·ª± nhi√™n", icon:"üî¨" },
    { name:"L·ªãch s·ª≠ & ƒê·ªãa l√Ω", icon:"üó∫Ô∏è" },
    { name:"GDCD", icon:"‚öñÔ∏è" },
    { name:"Ti·∫øng Anh", icon:"üåç" }
  ],
  8: [
    { name:"To√°n h·ªçc", icon:"üìê" },
    { name:"V·∫≠t l√Ω", icon:"‚ö°" },
    { name:"H√≥a h·ªçc", icon:"üß™" },
    { name:"Sinh h·ªçc", icon:"üå±" },
    { name:"L·ªãch s·ª≠", icon:"üèõÔ∏è" },
    { name:"ƒê·ªãa l√Ω", icon:"üåè" },
    { name:"Ti·∫øng Anh", icon:"üåç" }
  ],
  9: [
    { name:"To√°n h·ªçc", icon:"üìê" },
    { name:"V·∫≠t l√Ω", icon:"‚ö°" },
    { name:"H√≥a h·ªçc", icon:"üß™" },
    { name:"Sinh h·ªçc", icon:"üå±" },
    { name:"L·ªãch s·ª≠", icon:"üèõÔ∏è" },
    { name:"ƒê·ªãa l√Ω", icon:"üåè" },
    { name:"Ti·∫øng Anh", icon:"üåç" }
  ]
};

const TOPIC_SUGGESTIONS = {
  "To√°n h·ªçc": ["Ph√¢n s·ªë","H√†m s·ªë","Ph∆∞∆°ng tr√¨nh","H√¨nh h·ªçc","Th·ªëng k√™","S·ªë h·ªçc"],
  "Ng·ªØ VƒÉn": ["T√°c ph·∫©m vƒÉn h·ªçc","T·ª´ v·ª±ng","Ng·ªØ ph√°p","T·∫≠p l√†m vƒÉn","ƒê·ªçc hi·ªÉu"],
  "Khoa h·ªçc t·ª± nhi√™n": ["T·∫ø b√†o","L·ª±c v√† chuy·ªÉn ƒë·ªông","√Ånh s√°ng","Ch·∫•t v√† h·ªón h·ª£p"],
  "V·∫≠t l√Ω": ["ƒêi·ªán h·ªçc","Quang h·ªçc","C∆° h·ªçc","Nhi·ªát h·ªçc","S√≥ng"],
  "H√≥a h·ªçc": ["Nguy√™n t·ª≠","Ph·∫£n ·ª©ng h√≥a h·ªçc","Axit Baz∆° Mu·ªëi","H√≥a h·ªØu c∆°"],
  "Sinh h·ªçc": ["Di truy·ªÅn","T·∫ø b√†o","Sinh th√°i h·ªçc","H·ªá c∆° quan"],
  "L·ªãch s·ª≠": ["Vi·ªát Nam c·ªï ƒë·∫°i","Kh√°ng chi·∫øn","C√°ch m·∫°ng th√°ng T√°m","L·ªãch s·ª≠ th·∫ø gi·ªõi"],
  "L·ªãch s·ª≠ & ƒê·ªãa l√Ω": ["ƒê·ªãa l√Ω t·ª± nhi√™n","D√¢n c∆∞","L·ªãch s·ª≠ Vi·ªát Nam","L·ªãch s·ª≠ th·∫ø gi·ªõi"],
  "ƒê·ªãa l√Ω": ["ƒê·ªãa l√Ω t·ª± nhi√™n","Kinh t·∫ø","D√¢n s·ªë","M√¥i tr∆∞·ªùng"],
  "GDCD": ["Quy·ªÅn v√† nghƒ©a v·ª•","Ph√°p lu·∫≠t","ƒê·∫°o ƒë·ª©c","Kinh t·∫ø"],
  "Ti·∫øng Anh": ["Th√¨ ƒë·ªông t·ª´","T·ª´ v·ª±ng","K·ªπ nƒÉng ƒë·ªçc","Ng·ªØ ph√°p","K·ªπ nƒÉng vi·∫øt"]
};

const GRADE_COLORS = { 6:"--g6", 7:"--g7", 8:"--g8", 9:"--g9" };

/* ============================================================
   APP STATE
   ============================================================ */
const S = {
  grade: 6,
  subject: "To√°n h·ªçc",
  questions: [],        // generated questions
  activeQs: [],         // questions used in current game (shuffled)
  teamNames: { red:"ƒê·ªôi ƒê·ªè", blue:"ƒê·ªôi Xanh" },
  winTarget: 5,
  timeLimit: 20,
  // game
  scores: { red:0, blue:0 },
  currentTeam: "red",
  currentQ: 0,
  totalAnswered: 0,
  totalCorrect: 0,
  locked: false,
  timerVal: 0,
  timerInterval: null
};

/* ============================================================
   API KEY MANAGEMENT
   ============================================================ */
const KEY_STORAGE = 'keco_gemini_key';

function getApiKey() {
  return document.getElementById('api-key-input').value.trim() ||
         localStorage.getItem(KEY_STORAGE) || '';
}

function onKeyInput() {
  const val = document.getElementById('api-key-input').value.trim();
  const hint = document.getElementById('api-key-hint');
  const genBtn = document.getElementById('gen-btn');
  const inp = document.getElementById('api-key-input');

  if (!val) {
    inp.className = '';
    hint.className = 'api-key-hint';
    hint.textContent = 'Nh·∫≠p Google Gemini API Key (mi·ªÖn ph√≠). Key ch·ªâ l∆∞u tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.';
    genBtn.disabled = true;
    return;
  }

  if (val.startsWith('AIza') || val.length > 20) {
    inp.classList.add('key-ok');
    inp.classList.remove('key-err');
    hint.className = 'api-key-hint ok';
    hint.textContent = '‚úÖ Gemini API Key h·ª£p l·ªá ‚Äî s·∫µn s√†ng t·∫°o c√¢u h·ªèi!';
    genBtn.disabled = false;
    // L∆∞u key v√†o localStorage
    localStorage.setItem(KEY_STORAGE, val);
  } else {
    inp.classList.add('key-err');
    inp.classList.remove('key-ok');
    hint.className = 'api-key-hint err';
    hint.textContent = '‚ùå Key kh√¥ng h·ª£p l·ªá. Gemini Key th∆∞·ªùng b·∫Øt ƒë·∫ßu b·∫±ng AIza...';
    genBtn.disabled = true;
  }
}

function toggleKeyVis() {
  const inp = document.getElementById('api-key-input');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

function loadSavedKey() {
  const saved = localStorage.getItem(KEY_STORAGE);
  if (saved) {
    document.getElementById('api-key-input').value = saved;
    onKeyInput();
  }
}

/* ============================================================
   INIT
   ============================================================ */
(function init() {
  buildParticles();
  buildSubjectList(S.grade);
  buildTopicChips();
  buildStars();
  buildGrass();
  loadSavedKey();
})();

function buildParticles() {
  const grid = document.getElementById('pgrid');
  for (let i = 0; i < 60; i++) {
    const d = document.createElement('div');
    d.className = 'particle-dot';
    d.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;animation-duration:${2+Math.random()*4}s;animation-delay:${Math.random()*4}s;`;
    grid.appendChild(d);
  }
}

function buildStars() {
  const layer = document.getElementById('stars-layer');
  for (let i = 0; i < 60; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*90}%;animation-duration:${1.5+Math.random()*3}s;animation-delay:${Math.random()*3}s;`;
    layer.appendChild(s);
  }
}

function buildGrass() {
  const gl = document.getElementById('grass-line');
  for (let i = 0; i < 60; i++) {
    const g = document.createElement('div'); g.className = 'gb';
    gl.appendChild(g);
  }
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function goTo(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}

/* ============================================================
   GRADE & SUBJECT
   ============================================================ */
function selGrade(g) {
  S.grade = g;
  // Update CSS grade color
  const a = `var(--g${g})`, b = `var(--g${g}b)`;
  document.documentElement.style.setProperty('--ga', a);
  document.documentElement.style.setProperty('--gb', b);
  // Update tab UI
  [6,7,8,9].forEach(n => {
    const t = document.getElementById('gt-'+n);
    t.classList.toggle('sel', n===g);
  });
  // Re-build subjects
  S.subject = SUBJECTS[g][0].name;
  buildSubjectList(g);
  buildTopicChips();
  // Clear generated questions when grade changes
  S.questions = [];
  renderGeneratedQuestions();
  updateStartBtn();
}

function buildSubjectList(g) {
  const list = document.getElementById('subject-list');
  list.innerHTML = '';
  SUBJECTS[g].forEach((sub, i) => {
    const div = document.createElement('div');
    div.className = 'subj-item' + (i === 0 ? ' sel' : '');
    div.innerHTML = `<span class="si-icon">${sub.icon}</span>
      <span class="si-name">${sub.name}</span>
      <span class="si-check">${i===0?'‚úì':''}</span>`;
    div.onclick = () => selSubject(sub.name, div);
    list.appendChild(div);
  });
}

function selSubject(name, el) {
  S.subject = name;
  document.querySelectorAll('.subj-item').forEach(d => {
    d.classList.remove('sel');
    d.querySelector('.si-check').textContent = '';
  });
  el.classList.add('sel');
  el.querySelector('.si-check').textContent = '‚úì';
  buildTopicChips();
  // Clear questions on subject change
  S.questions = [];
  renderGeneratedQuestions();
  updateStartBtn();
}

function buildTopicChips() {
  const wrap = document.getElementById('topic-chips');
  wrap.innerHTML = '';
  const chips = TOPIC_SUGGESTIONS[S.subject] || [];
  chips.forEach(chip => {
    const d = document.createElement('div');
    d.className = 'topic-chip';
    d.textContent = chip;
    d.onclick = () => {
      const inp = document.getElementById('ai-topic');
      inp.value = chip;
      document.querySelectorAll('.topic-chip').forEach(c => c.classList.remove('active'));
      d.classList.add('active');
    };
    wrap.appendChild(d);
  });
}

/* ============================================================
   AI QUESTION GENERATION
   ============================================================ */
async function generateQuestions(append = false) {
  const count = parseInt(document.getElementById('ai-count').value) || 8;
  const diff  = document.getElementById('ai-diff').value;
  const topic = document.getElementById('ai-topic').value.trim();

  // UI: loading state
  const genBtn   = document.getElementById('gen-btn');
  const progress = document.getElementById('gen-progress');
  genBtn.disabled = true;
  progress.style.display = '';
  document.getElementById('empty-state').style.display = 'none';
  if (!append) showAiOverlay(`ƒêang t·∫°o ${count} c√¢u h·ªèi ${diff} cho m√¥n ${S.subject} l·ªõp ${S.grade}...`);

  const prompt = buildAIPrompt(count, diff, topic);

  try {
    /* ----------------------------------------------------------
       G·ªçi Anthropic API ‚Äî c·∫ßn header ƒë·∫∑c bi·ªát khi g·ªçi t·ª´ browser
       ---------------------------------------------------------- */
    const apiKey = getApiKey();
    if (!apiKey) {
      showErrorToast('Vui l√≤ng nh·∫≠p Google Gemini API Key tr∆∞·ªõc khi t·∫°o c√¢u h·ªèi!');
      return;
    }

    /* ----------------------------------------------------------
       Gemini API ‚Äî gemini-2.5-flash-lite, g·ªçi tr·ª±c ti·∫øp t·ª´ browser
       ---------------------------------------------------------- */
    const GEMINI_URL =
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite-preview-06-17:generateContent?key=${apiKey}`;

    const systemInstruction =
      `B·∫°n l√† chuy√™n gia gi√°o d·ª•c THCS Vi·ªát Nam. ` +
      `T·∫°o c√¢u h·ªèi tr·∫Øc nghi·ªám 4 l·ª±a ch·ªçn ƒë√∫ng ch∆∞∆°ng tr√¨nh THCS Vi·ªát Nam. ` +
      `"c" l√† s·ªë nguy√™n 0, 1, 2 ho·∫∑c 3 ‚Äî ch·ªâ v·ªã tr√≠ ƒë√°p √°n ƒë√∫ng trong m·∫£ng opts. ` +
      `opts l√† m·∫£ng 4 chu·ªói, kh√¥ng c√≥ ti·ªÅn t·ªë A. B. C. D.`;

    // responseSchema gi√∫p Gemini lu√¥n tr·∫£ v·ªÅ ƒë√∫ng c·∫•u tr√∫c JSON
    const responseSchema = {
      type: "object",
      properties: {
        questions: {
          type: "array",
          items: {
            type: "object",
            properties: {
              q:       { type: "string" },
              opts:    { type: "array", items: { type: "string" }, minItems: 4, maxItems: 4 },
              c:       { type: "integer", minimum: 0, maximum: 3 },
              explain: { type: "string" }
            },
            required: ["q", "opts", "c"]
          }
        }
      },
      required: ["questions"]
    };

    const response = await fetch(GEMINI_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        system_instruction: { parts: [{ text: systemInstruction }] },
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 4000,
          responseMimeType: "application/json",
          responseSchema: responseSchema
        }
      })
    });

    /* ----------------------------------------------------------
       Ki·ªÉm tra HTTP status
       ---------------------------------------------------------- */
    if (!response.ok) {
      const errBody = await response.text();
      let errMsg = `API HTTP ${response.status}`;
      try {
        const errJson = JSON.parse(errBody);
        errMsg += ': ' + (errJson?.error?.message || errBody.slice(0, 200));
      } catch { errMsg += ': ' + errBody.slice(0, 200); }
      throw new Error(errMsg);
    }

    const data = await response.json();
    console.log("Gemini raw response:", JSON.stringify(data).slice(0, 300));

    // Khi d√πng responseMimeType="application/json" + responseSchema,
    // Gemini tr·∫£ JSON trong parts[0].text d∆∞·ªõi d·∫°ng string ƒë√£ ƒë∆∞·ª£c parse s·∫µn
    const part = data?.candidates?.[0]?.content?.parts?.[0];
    const finishReason = data?.candidates?.[0]?.finishReason;

    if (!part) {
      const blockReason = data?.promptFeedback?.blockReason || finishReason;
      throw new Error(`Gemini kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu${blockReason ? ': ' + blockReason : ''}`);
    }

    // parts[0].text l√† JSON string khi d√πng responseMimeType
    const raw = typeof part.text === "string" ? part.text : JSON.stringify(part);

    if (!raw || !raw.trim()) throw new Error("Gemini tr·∫£ v·ªÅ n·ªôi dung r·ªóng");

    /* ----------------------------------------------------------
       Parse JSON ‚Äî th·ª≠ nhi·ªÅu c√°ch ƒë·ªÉ x·ª≠ l√Ω m·ªçi t√¨nh hu·ªëng
       ---------------------------------------------------------- */
    let parsed = null;

    // C√°ch 1: parse th·∫≥ng (Gemini v·ªõi responseSchema tr·∫£ JSON string)
    try { parsed = JSON.parse(raw.trim()); } catch (_) {}

    // C√°ch 2: raw ƒë√£ l√† object (Gemini ƒë√¥i khi tr·∫£ object tr·ª±c ti·∫øp)
    if (!parsed && typeof raw === "object" && raw !== null) {
      parsed = raw;
    }

    // C√°ch 3: t√¨m kh·ªëi JSON ƒë·∫ßu ti√™n trong string
    if (!parsed) {
      const start = raw.indexOf('{');
      const end   = raw.lastIndexOf('}');
      if (start !== -1 && end > start) {
        try { parsed = JSON.parse(raw.slice(start, end + 1)); } catch (_) {}
      }
    }

    // C√°ch 4: b√≥c markdown code block n·∫øu c√≥
    if (!parsed) {
      const mdMatch = raw.match(/```(?:json)?\s*([\s\S]*?)```/i);
      if (mdMatch) {
        try { parsed = JSON.parse(mdMatch[1].trim()); } catch (_) {}
      }
    }

    if (!parsed || !Array.isArray(parsed.questions) || parsed.questions.length === 0) {
      console.error("Gemini raw text:", raw);
      console.error("Gemini full data:", JSON.stringify(data));
      throw new Error("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ Gemini. M·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt.");
    }

    /* ----------------------------------------------------------
       Chu·∫©n h√≥a v√† validate t·ª´ng c√¢u h·ªèi
       ---------------------------------------------------------- */
    const newQs = parsed.questions
      .filter(q => q.q && Array.isArray(q.opts) && q.opts.length >= 2)
      .map(q => {
        // ƒê·∫£m b·∫£o ƒë·ªß 4 opts
        while (q.opts.length < 4) q.opts.push("...");
        // X√≥a ti·ªÅn t·ªë "A. " n·∫øu AI v·∫´n th√™m v√†o
        const cleanOpts = q.opts.slice(0, 4).map(o =>
          String(o).replace(/^[A-Da-d][\.\)]\s*/, "").trim()
        );
        const correctIdx = Math.max(0, Math.min(3, parseInt(q.c) || 0));
        return {
          q:           String(q.q).trim(),
          opts:        cleanOpts,
          c:           correctIdx,
          explain:     String(q.explain || "").trim(),
          aiGenerated: true
        };
      });

    if (newQs.length === 0) throw new Error("AI t·∫°o ƒë∆∞·ª£c 0 c√¢u h·ªèi h·ª£p l·ªá");

    S.questions = append ? [...S.questions, ...newQs] : newQs;
    renderGeneratedQuestions();
    updateStartBtn();

  } catch (err) {
    console.error("‚ùå L·ªói AI:", err);
    showErrorToast(`L·ªói: ${err.message}`);
  } finally {
    genBtn.disabled = false;
    progress.style.display = 'none';
    hideAiOverlay();
  }
}

function buildAIPrompt(count, diff, topic) {
  const topicStr = topic ? `Ch·ªß ƒë·ªÅ c·ª• th·ªÉ: "${topic}".` : '';
  const diffMap = {
    'd·ªÖ': 'Nh·∫≠n bi·∫øt (nh·ªõ l·∫°i ki·∫øn th·ª©c c∆° b·∫£n)',
    'trung b√¨nh': 'Th√¥ng hi·ªÉu (hi·ªÉu v√† √°p d·ª•ng)',
    'kh√≥': 'V·∫≠n d·ª•ng cao (ph√¢n t√≠ch, t·ªïng h·ª£p)',
    'h·ªón h·ª£p': 'H·ªón h·ª£p g·ªìm c·∫£ 3 m·ª©c: nh·∫≠n bi·∫øt, th√¥ng hi·ªÉu v√† v·∫≠n d·ª•ng'
  };

  return `T·∫°o ${count} c√¢u h·ªèi tr·∫Øc nghi·ªám 4 ƒë√°p √°n cho:
- M√¥n h·ªçc: ${S.subject}
- Kh·ªëi l·ªõp: L·ªõp ${S.grade} (THCS Vi·ªát Nam)
- M·ª©c ƒë·ªô: ${diffMap[diff] || diff}
${topicStr}

Y√™u c·∫ßu:
1. ƒê√∫ng ch∆∞∆°ng tr√¨nh SGK THCS Vi·ªát Nam hi·ªán h√†nh
2. C√¢u h·ªèi r√µ r√†ng, kh√¥ng m∆° h·ªì
3. Ch·ªâ c√≥ DUY NH·∫§T 1 ƒë√°p √°n ƒë√∫ng
4. 3 ƒë√°p √°n sai ph·∫£i h·ª£p l√Ω (kh√¥ng qu√° d·ªÖ nh·∫≠n ra sai)
5. ƒêa d·∫°ng lo·∫°i c√¢u h·ªèi (ƒë·ªãnh nghƒ©a, t√≠nh to√°n, ph√¢n t√≠ch, nh·∫≠n bi·∫øt)
6. Ti·∫øng Vi·ªát t·ª± nhi√™n, ph√π h·ª£p l·ª©a tu·ªïi
${S.subject === 'Ti·∫øng Anh' ? '7. C√¢u h·ªèi v·ªÅ ti·∫øng Anh: d√πng ti·∫øng Vi·ªát cho c√¢u d·∫´n, ti·∫øng Anh cho ƒë√°p √°n khi ph√π h·ª£p' : ''}

Tr·∫£ v·ªÅ JSON thu·∫ßn t√∫y theo format ƒë√£ ch·ªâ ƒë·ªãnh.`;
}

/* ============================================================
   ERROR TOAST ‚Äî hi·ªÉn th·ªã l·ªói kh√¥ng d√πng alert()
   ============================================================ */
function showErrorToast(msg) {
  // X√≥a toast c≈© n·∫øu c√≥
  const old = document.getElementById('err-toast');
  if (old) old.remove();

  const t = document.createElement('div');
  t.id = 'err-toast';
  t.style.cssText = `
    position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
    background:linear-gradient(135deg,#7f1d1d,#ef4444);
    color:white; padding:14px 24px; border-radius:12px;
    font-family:'Be Vietnam Pro',sans-serif; font-size:.88rem; font-weight:700;
    box-shadow:0 8px 32px rgba(239,68,68,.5); z-index:9999;
    max-width:480px; text-align:center; line-height:1.5;
    animation:toastIn .3s cubic-bezier(.34,1.56,.64,1);
  `;
  t.innerHTML = `‚ö†Ô∏è ${msg}<br><span style="font-weight:400;font-size:.78rem;opacity:.85;">Xem Console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt</span>`;

  // Th√™m animation keyframe n·∫øu ch∆∞a c√≥
  if (!document.getElementById('toast-style')) {
    const s = document.createElement('style');
    s.id = 'toast-style';
    s.textContent = '@keyframes toastIn{from{transform:translateX(-50%) translateY(20px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}';
    document.head.appendChild(s);
  }

  document.body.appendChild(t);
  setTimeout(() => t.remove(), 6000);

  // C≈©ng hi·ªán l·∫°i empty state
  document.getElementById('empty-state').style.display = '';
}

function getFallbackQs() {
  return [
    { q:`[L·ªõp ${S.grade}] C√¢u h·ªèi m·∫´u v·ªÅ ${S.subject} s·ªë 1?`, opts:["ƒê√°p √°n A","ƒê√°p √°n B","ƒê√°p √°n C","ƒê√°p √°n D"], c:0, aiGenerated:false },
    { q:`[L·ªõp ${S.grade}] C√¢u h·ªèi m·∫´u v·ªÅ ${S.subject} s·ªë 2?`, opts:["ƒê√°p √°n A","ƒê√°p √°n B","ƒê√°p √°n C","ƒê√°p √°n D"], c:1, aiGenerated:false },
    { q:`[L·ªõp ${S.grade}] C√¢u h·ªèi m·∫´u v·ªÅ ${S.subject} s·ªë 3?`, opts:["ƒê√°p √°n A","ƒê√°p √°n B","ƒê√°p √°n C","ƒê√°p √°n D"], c:2, aiGenerated:false },
  ];
}

async function generateMore() {
  await generateQuestions(true);
}

function clearGenerated() {
  S.questions = [];
  renderGeneratedQuestions();
  updateStartBtn();
}

function deleteQuestion(idx) {
  S.questions.splice(idx, 1);
  renderGeneratedQuestions();
  updateStartBtn();
}

function renderGeneratedQuestions() {
  const list = document.getElementById('gen-q-list');
  const wrap = document.getElementById('gen-qs-wrap');
  const empty = document.getElementById('empty-state');
  const count = document.getElementById('gen-count');

  if (S.questions.length === 0) {
    wrap.style.display = 'none';
    empty.style.display = '';
    return;
  }

  wrap.style.display = '';
  empty.style.display = 'none';
  count.textContent = S.questions.length;
  list.innerHTML = '';

  const labs = ['A','B','C','D'];
  S.questions.forEach((q, i) => {
    const item = document.createElement('div');
    item.className = 'gen-q-item';
    item.style.animationDelay = `${i * 0.05}s`;
    item.innerHTML = `
      <div class="gqi-actions">
        <button class="gqi-del-btn" onclick="deleteQuestion(${i})" title="X√≥a c√¢u n√†y">‚úï</button>
      </div>
      <div class="gqi-num">
        C√¢u ${i+1}
        ${q.aiGenerated ? '<span class="gqi-ai-tag">‚ú¶ AI</span>' : ''}
      </div>
      <div class="gqi-q">${q.q}</div>
      <div class="gqi-opts">
        ${q.opts.map((o,j)=>`<div class="gqi-opt ${j===q.c?'correct':''}">
          <span class="ol">${labs[j]}</span>${o}${j===q.c?' ‚úì':''}
        </div>`).join('')}
      </div>
      ${q.explain ? `<div style="font-size:.75rem;color:var(--text3);margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">üí° ${q.explain}</div>` : ''}
    `;
    list.appendChild(item);
  });
}

function updateStartBtn() {
  const n = S.questions.length;
  document.getElementById('sbi-count').textContent = n;
  document.getElementById('start-btn').disabled = n < 2;
}

/* ============================================================
   AI OVERLAY
   ============================================================ */
function showAiOverlay(msg) {
  const ov = document.getElementById('ai-overlay');
  ov.classList.add('show');
  document.getElementById('ago-status').textContent = msg;
  // Animate progress bar
  let p = 0;
  const bar = document.getElementById('ago-bar');
  const interval = setInterval(() => {
    p = Math.min(p + Math.random() * 15, 90);
    bar.style.width = p + '%';
  }, 300);
  ov._progressInterval = interval;
}

function hideAiOverlay() {
  const ov = document.getElementById('ai-overlay');
  const bar = document.getElementById('ago-bar');
  clearInterval(ov._progressInterval);
  bar.style.width = '100%';
  setTimeout(() => {
    ov.classList.remove('show');
    bar.style.width = '0%';
  }, 500);
}

/* ============================================================
   LAUNCH GAME
   ============================================================ */
function launchGame() {
  if (S.questions.length < 2) return;

  S.teamNames.red = document.getElementById('nm-red').value.trim() || 'ƒê·ªôi ƒê·ªè';
  S.teamNames.blue = document.getElementById('nm-blue').value.trim() || 'ƒê·ªôi Xanh';
  S.winTarget = parseInt(document.getElementById('win-n').value) || 5;
  S.timeLimit = parseInt(document.getElementById('time-n').value) || 0;

  S.scores = { red:0, blue:0 };
  S.currentTeam = 'red';
  S.currentQ = 0;
  S.totalAnswered = 0;
  S.totalCorrect = 0;
  S.locked = false;

  // Shuffle questions
  S.activeQs = [...S.questions].sort(() => Math.random() - .5);

  // Build game
  document.getElementById('tp-rname').textContent = S.teamNames.red;
  document.getElementById('tp-bname').textContent = S.teamNames.blue;
  document.getElementById('cp-subject').textContent = `${S.subject} ¬∑ L${S.grade}`;
  buildStickmen();
  buildPips();

  goTo('game');
  AU.gameStart();
  setTimeout(() => AU.startBg(), 1500);
  updateRope();
  renderQ();
}

/* ============================================================
   STICKMEN
   ============================================================ */
function stick(col) {
  return `<svg viewBox="0 0 38 66" xmlns="http://www.w3.org/2000/svg">
    <circle cx="19" cy="8.5" r="7.5" fill="${col}" opacity=".95"/>
    <circle cx="16" cy="7.5" r="1.7" fill="white" opacity=".9"/>
    <circle cx="22" cy="7.5" r="1.7" fill="white" opacity=".9"/>
    <path d="M14 12.5 Q19 15.5 24 12.5" stroke="white" stroke-width="1.5" fill="none" stroke-linecap="round" opacity=".85"/>
    <line x1="19" y1="16" x2="19" y2="40" stroke="${col}" stroke-width="3" stroke-linecap="round"/>
    <line x1="19" y1="24" x2="4" y2="34" stroke="${col}" stroke-width="2.5" stroke-linecap="round"/>
    <line x1="19" y1="24" x2="34" y2="34" stroke="${col}" stroke-width="2.5" stroke-linecap="round"/>
    <line x1="19" y1="40" x2="8" y2="60" stroke="${col}" stroke-width="2.5" stroke-linecap="round"/>
    <line x1="19" y1="40" x2="30" y2="60" stroke="${col}" stroke-width="2.5" stroke-linecap="round"/>
  </svg>`;
}

function buildStickmen() {
  const r = document.getElementById('st-red'); r.innerHTML = '';
  const b = document.getElementById('st-blue'); b.innerHTML = '';
  for (let i = 0; i < 4; i++) {
    const dr = document.createElement('div'); dr.className='stk ra'; dr.style.animationDelay=`${i*.12}s`;
    dr.innerHTML = stick('#fca5a5'); r.appendChild(dr);
    const db = document.createElement('div'); db.className='stk ba'; db.style.animationDelay=`${i*.12}s`;
    db.innerHTML = stick('#93c5fd'); b.appendChild(db);
  }
}

function buildPips() {
  const pr = document.getElementById('pip-r'); pr.innerHTML = '';
  const pb = document.getElementById('pip-b'); pb.innerHTML = '';
  for (let i = 0; i < S.winTarget; i++) {
    const dr = document.createElement('div'); dr.className='pip'; dr.id='pr-'+i; pr.appendChild(dr);
    const db = document.createElement('div'); db.className='pip'; db.id='pb-'+i; pb.appendChild(db);
  }
}

/* ============================================================
   GAME LOGIC
   ============================================================ */
function updateRope() {
  const { scores, winTarget, currentTeam, teamNames } = S;
  const kp = Math.max(5, Math.min(95, 50 - (scores.red/winTarget*50) + (scores.blue/winTarget*50)));
  document.getElementById('rknot').style.left = kp + '%';
  document.getElementById('rr').style.width = kp + '%';
  document.getElementById('rb').style.width = (100-kp) + '%';
  document.getElementById('tp-rscore').textContent = scores.red;
  document.getElementById('tp-bscore').textContent = scores.blue;

  for (let i = 0; i < S.winTarget; i++) {
    const pr = document.getElementById('pr-'+i); if(pr) pr.className='pip'+(i<scores.red?' pr':'');
    const pb = document.getElementById('pb-'+i); if(pb) pb.className='pip'+(i<scores.blue?' pb':'');
  }

  const td = document.getElementById('tdot'), tl = document.getElementById('tlabel');
  td.className = 'tdot ' + (currentTeam==='red'?'r':'b');
  tl.textContent = 'L∆∞·ª£t c·ªßa ' + teamNames[currentTeam];
}

function renderQ() {
  if (S.currentQ >= S.activeQs.length) S.currentQ = 0;
  const q = S.activeQs[S.currentQ];
  document.getElementById('cp-qnum').textContent = `C√¢u ${S.totalAnswered + 1}`;
  document.getElementById('q-box').textContent = q.q;
  document.getElementById('q-ai-ind').style.display = q.aiGenerated ? '' : 'none';

  const grid = document.getElementById('ans-grid'); grid.innerHTML = '';
  const labs = ['A','B','C','D'];
  q.opts.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'ans-btn';
    btn.innerHTML = `<span class="ab-badge">${labs[i]}</span>${opt}`;
    btn.onclick = () => answer(i);
    grid.appendChild(btn);
  });

  S.locked = false;
  AU.questionAppear();
  startTimer();
}

function startTimer() {
  clearInterval(S.timerInterval);
  const tw = document.getElementById('timer-wrap');
  if (!S.timeLimit) { tw.style.display = 'none'; return; }
  tw.style.display = '';
  S.timerVal = S.timeLimit;
  updateTimerUI();
  S.timerInterval = setInterval(() => {
    S.timerVal--;
    updateTimerUI();
    if (S.timerVal <= 0) { clearInterval(S.timerInterval); if (!S.locked) timeUp(); }
  }, 1000);
}

function updateTimerUI() {
  const pct = (S.timerVal / S.timeLimit) * 100;
  const bar = document.getElementById('timer-fill');
  bar.style.width = pct + '%';
  bar.className = 'timer-fill' + (pct < 30 ? ' warn' : '');
  // √Çm thanh tick ƒë·∫øm ng∆∞·ª£c
  if (S.timerVal <= 5 && S.timerVal > 0) AU.timeoutWarn();
  else if (S.timerVal > 5 && S.timerVal % 5 === 0) AU.timeTick();
}

function timeUp() {
  S.locked = true;
  AU.timeup();
  const q = S.activeQs[S.currentQ];
  document.querySelectorAll('.ans-btn').forEach((b,i) => { b.disabled=true; if(i===q.c) b.classList.add('rv'); });
  showFb(false, '‚è∞ H·∫øt gi·ªù!');
  S.totalAnswered++;
  S.currentTeam = S.currentTeam === 'red' ? 'blue' : 'red';
  S.currentQ = (S.currentQ + 1) % S.activeQs.length;
  setTimeout(() => { updateRope(); renderQ(); }, 1300);
}

function answer(idx) {
  if (S.locked) return;
  S.locked = true;
  clearInterval(S.timerInterval);

  const q = S.activeQs[S.currentQ];
  const ok = idx === q.c;
  S.totalAnswered++;
  if (ok) { S.totalCorrect++; S.scores[S.currentTeam]++; AU.correct(); AU.ropeGain(); }
  else { AU.wrong(); }

  document.querySelectorAll('.ans-btn').forEach((b,i) => {
    b.disabled = true;
    if (i===q.c) b.classList.add('ok');
    else if (i===idx) b.classList.add('ng');
  });

  if (!ok) {
    document.getElementById('rope-track').classList.add('shaking');
    setTimeout(() => document.getElementById('rope-track').classList.remove('shaking'), 500);
  }

  showFb(ok);

  if (ok && S.scores[S.currentTeam] >= S.winTarget) {
    setTimeout(() => showWin(), 1000);
    return;
  }

  S.currentTeam = S.currentTeam === 'red' ? 'blue' : 'red';
  S.currentQ = (S.currentQ + 1) % S.activeQs.length;
  setTimeout(() => { updateRope(); renderQ(); }, 1300);
}

function showFb(ok, custom = null) {
  const ov = document.getElementById('fb-ov'), bx = document.getElementById('fb-box');
  const name = S.teamNames[S.currentTeam];
  if (custom) { bx.className='fb-box ng'; bx.innerHTML=custom; }
  else if (ok) { bx.className='fb-box ok'; bx.innerHTML=`‚úÖ ${name} K√âO ƒë∆∞·ª£c! üí™`; }
  else { bx.className='fb-box ng'; bx.innerHTML=`‚ùå Sai r·ªìi! ƒê·ªïi l∆∞·ª£t!`; }
  ov.classList.add('show');
  setTimeout(() => ov.classList.remove('show'), 1050);
}

/* ============================================================
   WIN
   ============================================================ */
function showWin() {
  clearInterval(S.timerInterval);
  AU.stopBg();
  AU.victory();
  const w = S.currentTeam;
  document.getElementById('win-name').textContent = S.teamNames[w];
  document.getElementById('win-name').className = 'win-name ' + (w==='red'?'r':'b');
  document.getElementById('win-rs').textContent = S.scores.red;
  document.getElementById('win-bs').textContent = S.scores.blue;
  document.getElementById('ws-total').textContent = S.totalAnswered;
  document.getElementById('ws-cor').textContent = S.totalCorrect;
  document.getElementById('ws-pct').textContent = S.totalAnswered > 0 ? Math.round(S.totalCorrect/S.totalAnswered*100)+'%' : '0%';
  confetti(w);
  goTo('win');
}

function confetti(w) {
  const layer = document.getElementById('cp-layer'); layer.innerHTML = '';
  const cols = w==='red'
    ? ['#fca5a5','#ef4444','#fff','#fde68a','#ff6b35']
    : ['#93c5fd','#3b82f6','#fff','#fde68a','#6ee7b7'];
  for (let i = 0; i < 90; i++) {
    const p = document.createElement('div'); p.className='cp-p';
    p.style.cssText=`left:${Math.random()*100}%;background:${cols[i%cols.length]};width:${7+Math.random()*9}px;height:${12+Math.random()*16}px;animation-duration:${1.4+Math.random()*2.2}s;animation-delay:${Math.random()*1.8}s;transform:rotate(${Math.random()*360}deg);border-radius:${Math.random()>.5?'50%':'3px'};`;
    layer.appendChild(p);
  }
}

function restartGame() {
  S.scores = { red:0, blue:0 }; S.currentTeam='red'; S.currentQ=0;
  S.totalAnswered=0; S.totalCorrect=0; S.locked=false;
  S.activeQs = [...S.questions].sort(() => Math.random() - .5);
  buildPips();
  goTo('game');
  AU.startBg();
  updateRope();
  renderQ();
}

async function regenAndPlay() {
  goTo('config');
  await generateQuestions(false);
  if (S.questions.length >= 2) launchGame();
}
/* ============================================================
   üîä AUDIO ENGINE ‚Äî Web Audio API (kh√¥ng c·∫ßn file ngo√†i)
   ============================================================ */
const AU = (() => {
  let ctx = null;
  let bgGain = null;
  let bgNodes = [];   // c√°c node nh·∫°c n·ªÅn ƒëang ch·∫°y
  let muted = false;

  function getCtx() {
    if (!ctx) {
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      bgGain = ctx.createGain();
      bgGain.gain.value = 0.18;
      bgGain.connect(ctx.destination);
    }
    if (ctx.state === 'suspended') ctx.resume();
    return ctx;
  }

  /* ---- T·∫°o 1 oscillator ng·∫Øn ---- */
  function beep({ freq = 440, type = 'sine', vol = 0.4, dur = 0.15,
                  start = 0, freqEnd = null, attack = 0.01, release = 0.08 }) {
    const c = getCtx();
    const osc = c.createOscillator();
    const gain = c.createGain();
    osc.connect(gain); gain.connect(c.destination);
    osc.type = type;
    osc.frequency.setValueAtTime(freq, c.currentTime + start);
    if (freqEnd) osc.frequency.exponentialRampToValueAtTime(freqEnd, c.currentTime + start + dur);
    gain.gain.setValueAtTime(0, c.currentTime + start);
    gain.gain.linearRampToValueAtTime(vol, c.currentTime + start + attack);
    gain.gain.setValueAtTime(vol, c.currentTime + start + dur - release);
    gain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + start + dur);
    osc.start(c.currentTime + start);
    osc.stop(c.currentTime + start + dur + 0.01);
  }

  /* ---- Ti·∫øng tr·ªëng/g√µ ---- */
  function drum({ freq = 80, vol = 0.5, dur = 0.3, start = 0 }) {
    const c = getCtx();
    const osc = c.createOscillator();
    const gain = c.createGain();
    osc.connect(gain); gain.connect(c.destination);
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(freq * 2.5, c.currentTime + start);
    osc.frequency.exponentialRampToValueAtTime(freq * 0.3, c.currentTime + start + dur);
    gain.gain.setValueAtTime(vol, c.currentTime + start);
    gain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + start + dur);
    osc.start(c.currentTime + start);
    osc.stop(c.currentTime + start + dur + 0.01);
  }

  /* ---- Ti·∫øng hi-hat ---- */
  function hihat({ vol = 0.08, start = 0, dur = 0.05 }) {
    const c = getCtx();
    const bufSize = c.sampleRate * dur;
    const buf = c.createBuffer(1, bufSize, c.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1);
    const src = c.createBufferSource();
    const hpf = c.createBiquadFilter();
    const gain = c.createGain();
    hpf.type = 'highpass'; hpf.frequency.value = 8000;
    src.buffer = buf;
    src.connect(hpf); hpf.connect(gain); gain.connect(c.destination);
    gain.gain.setValueAtTime(vol, c.currentTime + start);
    gain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + start + dur);
    src.start(c.currentTime + start);
    src.stop(c.currentTime + start + dur + 0.01);
  }

  /* ---- Ti·∫øng v·ªó tay / clash ---- */
  function clash({ vol = 0.15, start = 0 }) {
    const c = getCtx();
    for (let i = 0; i < 3; i++) {
      const t = start + i * 0.02;
      hihat({ vol: vol * (1 - i * 0.25), start: t, dur: 0.08 });
    }
  }

  /* ==========================================================
     PUBLIC API
     ========================================================== */

  return {
    /* B·∫≠t/t·∫Øt √¢m */
    toggle() {
      muted = !muted;
      if (muted) { AU.stopBg(); }
      else { AU.startBg(); }
      return muted;
    },
    isMuted() { return muted; },

    /* --- Nh·∫°c n·ªÅn k√©o co (loop t·ª± ƒë·ªông) --- */
    startBg() {
      if (muted) return;
      AU.stopBg();
      const loopBeat = () => {
        if (muted) return;
        const now = getCtx().currentTime;
        const bpm = 132; const beat = 60 / bpm;

        // Kick drum ‚Äî nh·ªãp 1 v√† 3
        drum({ freq: 55, vol: 0.55, dur: 0.35, start: 0 });
        drum({ freq: 55, vol: 0.45, dur: 0.3,  start: beat * 2 });
        // Snare ‚Äî nh·ªãp 2 v√† 4
        drum({ freq: 200, vol: 0.3, dur: 0.12, start: beat });
        drum({ freq: 200, vol: 0.3, dur: 0.12, start: beat * 3 });
        // Hi-hat li√™n t·ª•c
        for (let i = 0; i < 8; i++) hihat({ vol: 0.07, start: i * beat * 0.5, dur: 0.04 });

        // Bassline h√†o h·ª©ng
        const bass = [130, 130, 98, 110, 130, 110, 98, 130];
        bass.forEach((f, i) => beep({ freq: f, type: 'sawtooth', vol: 0.06, dur: beat * 0.45, start: i * beat * 0.5 }));

        // Chord stab m·ªói 2 nh·ªãp
        [0, beat * 2].forEach(t => {
          [523, 659, 784].forEach(f =>
            beep({ freq: f, type: 'square', vol: 0.025, dur: 0.12, start: t, attack: 0.005, release: 0.05 })
          );
        });

        bgNodes._loopId = setTimeout(loopBeat, beat * 4 * 1000);
      };
      loopBeat();
    },

    stopBg() {
      clearTimeout(bgNodes._loopId);
      bgNodes._loopId = null;
    },

    /* --- C√¢u h·ªèi m·ªõi xu·∫•t hi·ªán --- */
    questionAppear() {
      if (muted) return;
      beep({ freq: 880, type: 'sine', vol: 0.3, dur: 0.08, start: 0 });
      beep({ freq: 1100, type: 'sine', vol: 0.25, dur: 0.1, start: 0.09 });
    },

    /* --- Tr·∫£ l·ªùi ƒê√öNG: fanfare vui v·∫ª --- */
    correct() {
      if (muted) return;
      const melody = [
        { freq: 523, start: 0,    dur: 0.1 },
        { freq: 659, start: 0.1,  dur: 0.1 },
        { freq: 784, start: 0.2,  dur: 0.12 },
        { freq: 1047,start: 0.32, dur: 0.22 },
      ];
      melody.forEach(n => beep({ ...n, type: 'sine', vol: 0.38, attack: 0.01, release: 0.06 }));
      // Chord n·ªÅn
      [523, 659, 784].forEach(f =>
        beep({ freq: f, type: 'triangle', vol: 0.08, dur: 0.55, start: 0.3, attack: 0.02 })
      );
      // Ti·∫øng v·ªó tay
      [0, 0.05, 0.55, 0.6].forEach(t => clash({ vol: 0.12, start: t }));
    },

    /* --- Tr·∫£ l·ªùi SAI: √¢m th·ª•t xu·ªëng --- */
    wrong() {
      if (muted) return;
      beep({ freq: 400, freqEnd: 200, type: 'sawtooth', vol: 0.3, dur: 0.25, attack: 0.01 });
      beep({ freq: 300, freqEnd: 150, type: 'square',   vol: 0.12, dur: 0.3,  start: 0.05, attack: 0.01 });
      drum({ freq: 60, vol: 0.35, dur: 0.3, start: 0.1 });
    },

    /* --- H·∫øt gi·ªù: tick tock cƒÉng th·∫≥ng --- */
    timeoutWarn() {
      if (muted) return;
      beep({ freq: 1200, type: 'square', vol: 0.2, dur: 0.06 });
    },

    timeTick() {
      if (muted) return;
      beep({ freq: 880, type: 'square', vol: 0.15, dur: 0.05 });
    },

    timeup() {
      if (muted) return;
      beep({ freq: 300, freqEnd: 100, type: 'sawtooth', vol: 0.4, dur: 0.5, attack: 0.01 });
      drum({ freq: 70, vol: 0.5, dur: 0.4, start: 0.05 });
    },

    /* --- K√©o ƒë∆∞·ª£c ƒëi·ªÉm: √¢m h√†o h·ª©ng + ti·∫øng k√©o --- */
    ropeGain() {
      if (muted) return;
      beep({ freq: 300, freqEnd: 500, type: 'sine', vol: 0.25, dur: 0.2, attack: 0.01 });
      clash({ vol: 0.18, start: 0.15 });
    },

    /* --- B·∫Øt ƒë·∫ßu game: countdown tr·ªëng --- */
    gameStart() {
      if (muted) return;
      [0, 0.3, 0.6].forEach(t => drum({ freq: 80, vol: 0.5, dur: 0.25, start: t }));
      beep({ freq: 880, type: 'sine', vol: 0.4, dur: 0.4, start: 0.9 });
      beep({ freq: 1100, type: 'sine', vol: 0.45, dur: 0.5, start: 1.3, attack: 0.01 });
    },

    /* --- Chi·∫øn th·∫Øng: fanfare ho√†nh tr√°ng --- */
    victory() {
      if (muted) return;
      AU.stopBg();
      const fanfare = [
        523, 523, 523, 698, 0, 523, 698, 1047
      ];
      const durs =  [0.15, 0.15, 0.15, 0.4, 0.1, 0.15, 0.15, 0.6];
      let t = 0;
      fanfare.forEach((f, i) => {
        if (f > 0) {
          beep({ freq: f, type: 'sine', vol: 0.45, dur: durs[i], start: t, attack: 0.01, release: 0.06 });
          // Harmony
          beep({ freq: f * 1.25, type: 'sine', vol: 0.18, dur: durs[i], start: t });
          beep({ freq: f * 1.5,  type: 'sine', vol: 0.12, dur: durs[i], start: t });
        }
        t += durs[i] + 0.02;
      });
      // Tr·ªëng r·ªôn
      [0, 0.3, 0.6, 0.9, 1.2].forEach(t2 => {
        drum({ freq: 60, vol: 0.5, dur: 0.25, start: t2 });
        clash({ vol: 0.2, start: t2 + 0.15 });
      });
    },

    /* --- N√∫t √¢m thanh toggle --- */
    buildToggleBtn() {
      const btn = document.createElement('button');
      btn.id = 'sound-toggle';
      btn.innerHTML = 'üîä';
      btn.title = 'B·∫≠t/t·∫Øt √¢m thanh';
      btn.style.cssText = `
        position: fixed; bottom: 20px; right: 20px; z-index: 500;
        width: 46px; height: 46px; border-radius: 50%; border: none;
        background: rgba(255,255,255,.12); backdrop-filter: blur(8px);
        border: 1px solid rgba(255,255,255,.2);
        font-size: 1.3rem; cursor: pointer; transition: all .2s;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 16px rgba(0,0,0,.4);
      `;
      btn.onmouseenter = () => btn.style.background = 'rgba(255,255,255,.22)';
      btn.onmouseleave = () => btn.style.background = 'rgba(255,255,255,.12)';
      btn.onclick = () => {
        const m = AU.toggle();
        btn.innerHTML = m ? 'üîá' : 'üîä';
        btn.style.opacity = m ? '.5' : '1';
      };
      document.body.appendChild(btn);
    }
  };
})();


/* ============================================================
   DEVELOPER MODAL
   ============================================================ */
function openDevModal() {
  document.getElementById('dev-modal').classList.add('open');
}
function closeDevModal(e) {
  if (!e || e.target === document.getElementById('dev-modal')) {
    document.getElementById('dev-modal').classList.remove('open');
  }
}
// ƒê√≥ng b·∫±ng ph√≠m Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('dev-modal').classList.remove('open');
});

// Kh·ªüi t·∫°o n√∫t √¢m thanh
AU.buildToggleBtn();
</script>
</body>
</html>
